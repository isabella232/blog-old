<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: articles | Rollbar - Blog - real-time error tracking for Rails, Python, PHP, Javascript, and Flash]]></title>
  <link href="https://rollbar.com/blog/blog/categories/articles/atom.xml" rel="self"/>
  <link href="https://rollbar.com/blog/"/>
  <updated>2014-04-08T17:24:46-07:00</updated>
  <id>https://rollbar.com/blog/</id>
  <author>
    <name><![CDATA[Rollbar, Inc.]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Async node.js API server testing]]></title>
    <link href="https://rollbar.com/blog/post/2013/07/12/Async-nodejs-API-server-testing/"/>
    <updated>2013-07-12T01:20:00-07:00</updated>
    <id>https://rollbar.com/blog/post/2013/07/12/Async-nodejs-API-server-testing</id>
    <content type="html"><![CDATA[<p>This post is about how we built our test suite for our API server at <a href="http://rollbar.com/">Rollbar</a> and some of the tricks and gotchas we ran into along the way. We wanted to build a test suite that not only tested the API logic, but also the underlying code, namely the <a href="http://expressjs.com/">Express</a> and the <a href="http://www.senchalabs.org/connect/">Connect</a> middlewares we use. If our API server was going to break, we wanted to know before we deployed it to thousands of customers and millions of requests per day.</p>

<p>Testing is super important. If you don't want to test, this probably won't be very helpful or interesting.</p>

<h2>We use Vows. Why not Mocha?</h2>

<p><a href="http://visionmedia.github.io/mocha/">Mocha</a> is, by far, the most widely used testing framework for Node.js apps. So, why didn't we use it? The two main reasons were that Vows was the first thing I found when Googling "nodejs async testing" and the other is that the syntax of Mocha tests felt like another language and less like code. Mocha tests are more readble but the benefit of readability was overshadowed by the need to remember all of these new, special-case methods that Mocha injects.</p>

<p><code>javascript
//Mocha
[1,2,3].indexOf(5).should.equal(-1);
</code></p>

<p>vs</p>

<p><code>javascript
//Vows
assert.equal([1,2,3].indexOf(5), -1);
</code></p>

<p>There's something that bothered me about the former. I didn't like how the library used a bunch of magic to enable something this small/strange.</p>

<p>Mocha has a lot of awesome features but none that were important enough for me to switch.</p>

<h2>A simple Vows test</h2>

<p>Vows works just as you'd expect it to, except when it doesn't. More on that later…</p>

<p>``` javascript
var vows = require('vows');
var assert = require('assert');
vows.describe('testmodule').addBatch({
  "call username() with a valid user id": {</p>

<pre><code>topic: function() {
  var callback = this.callback;
  return username(42, this.callback);
},
"and verify username is correct": function(err, username) {
  assert.isNull(err);
  assert.isString(username);
  assert.equal(username, "cory");
}
</code></pre>

<p>  }
}).export(module, {error: false});
```</p>

<p>The above test will make sure that the function <code>username()</code> calls its callback with <code>(null, "cory")</code>.</p>

<p>Note that we use this.callback since everything is assumed to be async and we use <code>{error: false}</code> when we export the batch. More on those later.</p>

<p>Check out the Vows <a href="http://vowsjs.org/">website</a> for better examples.</p>

<h2>Useful design patterns (I swear this will be short)</h2>

<p>We've found a few idioms and conventions that have been super helpful. Without going too much into design patterns and architecture, here are a few tips that have made writing tests super-easy; almost enjoyable—almost.</p>

<h3>Separate your view logic from your API business logic</h3>

<p>Your server's views should have one job, to marshall data from the request/socket/carrier pigeon and provide it to your API library.</p>

<p>Any error checking done in your views should be to make sure the types provided to your API library are correct.</p>

<h3>Make every function you write use a callback.</h3>

<p>This is super-important for refactoring and adding new features. If you find yourself wanting to add a feature that requires i/o into a code path that was assumed to be completely synchonous, you'll need to refactor the hell our of your code to make it work. Don't bother. Make everything take a callback. Embrace async!</p>

<h3>Make the first argument to <em>every</em> callback be an optional error.</h3>

<p>This is how the Node.js developers do it and I agree. It makes for a lot more boiler-plate code but it forces you to keep error handling in-mind when developing. Writing defensive code is more important than writing fewer lines of code.</p>

<p>This will also make testing much, much easier with Vows. How? Read on…</p>

<h2>Testing the API server, for reals</h2>

<p>Definitely write tests and exercise your API library directly but don't stop there. Fork a process, start your API server up in it and start firing requests at it using Vows.</p>

<p>testcommon.js:</p>

<p>``` javascript
exports.initTestingAppChildProc = function(config, promise) {
  // ... Setup temporary config file
  // ... Get path to your main app.js
  // ... Initialize the api library</p>

<p>  // fork a child process to start the api server
  var args = [configPath, 'test'];
  var appProc = fork(appJsPath, args);</p>

<p>  // This is used to tell if our API server died during its
  // initialization.
  var pendingCallback = true;</p>

<p>  appProc.on('message', function(message) {</p>

<pre><code>if (message == 'ready') {
  pendingCallback = false;

  // This is how we know our API server is ready to 
  // receive requests. The message is emitted in the
  // API server once it's ready to receive requests.
  promise.emit('success', null, appProc);
}
</code></pre>

<p>  });
  appProc.on('exit', function(code, signal) {</p>

<pre><code>if (pendingCallback) {
  var msg = 'child process exited before callback';
  console.error(msg);
  promise.emit('error', new Error(msg));
}
</code></pre>

<p>  });
  appProc.on('SIGTERM', function() {</p>

<pre><code>process.exit();
</code></pre>

<p>  });
};
```</p>

<p>In our API server:</p>

<p>``` javascript
// initialize the API and start the web server when it's ready
api.init(config, function(err) {
  if (err) {</p>

<pre><code>log.error('Could not initialize API: ' + err);
process.exit(1);
</code></pre>

<p>  } else {</p>

<pre><code>// Start up the server
var httpServer = app.listen(port, host, function() {
  log.info('API server is ready.');
  log.info('Listening on ' + host + ':' + port);

  // Use the "ready" message to signal that the server is ready.
  // This is used by the test suite to wait for the api server
  // process to start up before sending requests.
  if (process.send) {
    process.send('ready');
  }
});
</code></pre>

<p>  }
});
```</p>

<p>tests/routes.project.js:</p>

<p>``` javascript
vows.describe('routes.project').addBatch({
  // Provides a reference to the api server child process
  'Start up an API server': {</p>

<pre><code>topic: function() {
  var promise = new events.EventEmitter();
  common.initTestingAppChildProc(config, promise);
  return promise;
},
teardown: function(err, childProc) {
  var callback = this.callback;
  var shutdown = function() {
    api.shutdown(callback);
  };
  if (childProc) {
    childProc.on('exit', function(code, sig) {
      shutdown();
    });
    childProc.kill();
  } else {
    shutdown();
  }
},
'and get a valid project': {
  topic: function(err, childProc) {
    common.apiGet(url('api/1/project/',
        {access_token: config.test.validEnabledReadAccessToken}), this.callback);
  },
  'returns 200 OK': common.assertStatus(200),
  'returns JSON': common.assertJsonContentType(),
  'fast local response time': common.assertMaxResponseTime(20),
  "returns a valid api response": common.assertValidApiResponse(),
  "has a result key in the JSON response": common.assertJsonHasFields(['result']),
  "there's no api error": common.assertNoApiError(),
  'all of the deploy fields are available': common.assertJsonHasFields(db.projectFields(),
      'result'),
  'cross-check account id with api.getAccount': {
    topic: function(err, resp, body) {
      var project = body.result;
      api.getAccount(body.result.account_id, this.callback);
    },
    'verify the account is not null': function(err, account) {
      assert.isNull(err);      
      assert.isObject(account);         
    }       
  }
}
</code></pre>

<p>}).export(module, {error: false});
```</p>

<p>There is a lot happening in these tests.</p>

<ul>
<li>We use promises to notify our test when the API server is ready.

<ul>
<li>Documentation for using promises with Vows can be found <a href="http://vowsjs.org/#-writing-asynchronous-tests">here</a>.</li>
<li>I'm not completely on-board with the Promise design pattern but it seemed like the easiest way to get this working. Mostly, I needed an event to be fired when there was an error that caused the API server process to shut down.</li>
</ul>
</li>
<li>We use a Vows teardown function to shut down the API server process.</li>
<li>We use our API library to help test our API server.

<ul>
<li>We cross-check our API server's response by using our API library directly.</li>
</ul>
</li>
<li>We use Vows macros for reusable tests on all API requests.

<ul>
<li>We also make use of Vows contexts even though there are none in this example.</li>
<li>Documentation for macros and contexts are <a href="http://vowsjs.org/#-macros">here</a>.</li>
</ul>
</li>
</ul>


<h2>Gotchas</h2>

<p>Never, ever, ever throw an uncaught exception in a Vows topic. It makes debugging impossible. I've wasted hours looking through my API library for a bug only to find that I had a silly bug in my topic.</p>

<p>Always use <code>export(module, {error: false})</code> in your Vows batches. This option is not really described in the Vows docs. I had to find it in the source. Basically, if you don't have this, Vows will inspect the first argument to each test to see if it's an error. Vows will potentially call your test functions with a different set of arguments depending on if the first parameter to the topic's callback is an Error or not. It's completely strange and magical and <a href="https://github.com/cloudhead/vows/pull/263">confusing</a>.</p>

<p>Testing without mock objects means that you need a real database which means you probably need real-ish data to test with. This is tough. We chose to maintain a DB SQL fixture that we have to update whenever the schema changes. It's a bit clunky but it works. I'm open to suggestions for this if anyone knows of a better way.</p>

<h2>Wrapping up…</h2>

<p>We use <a href="http://circleci.com">CircleCI</a> to run all of these tests and are really happy with their service. It's fast and easy to set up. Also, it has all of the systems that our API server uses like MySQL, Beanstalkd and Memcache pre-installed. This gets us closer to testing in a production environment than would otherwise be possible.</p>

<p>Hopefully you were able to glean some useful tips from our experience at <a href="http://rollbar.com/">Rollbar</a>. We love building tools for devs like you!</p>

<p>Add me on Twitter <a href="https://twitter.com/coryvirok">@coryvirok</a>.
Follow <a href="https://twitter.com/rollbar">@rollbar</a> for more updates.</p>

<h2>Moment of zen</h2>

<p><code>
✓ OK » 497 honored (33.232s)
</code></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Taking UNIQUE indexes to the next level]]></title>
    <link href="https://rollbar.com/blog/post/2013/03/29/using-unique-indexes-for-fun-and-profit/"/>
    <updated>2013-03-29T09:15:00-07:00</updated>
    <id>https://rollbar.com/blog/post/2013/03/29/using-unique-indexes-for-fun-and-profit</id>
    <content type="html"><![CDATA[<p>You've probably seen unique constraints somewhere -- either in Rails' <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#uniqueness"><code>validates :uniqueness</code></a>, Django's <a href="https://docs.djangoproject.com/en/dev/ref/models/fields/#unique"><code>Field.unique</code></a>, or a raw SQL <a href="http://dev.mysql.com/doc/refman/5.5/en/create-index.html">table definition</a>. The basic function of unique constraints (preventing duplicate data from being inserted) is nice, but they're so much more powerful than that. When you write INSERT or REPLACE statements that rely on them, you can do some pretty cool (and efficient) things that you would've had to do multiple queries for otherwise.</p>

<p>This post covers unique indexes in MySQL 5.5. Other versions of MySQL are similar. I'm not sure about Postgres or other relational databases but presume they're similar-ish as well.</p>

<h2>Primer: what is a unique index?</h2>

<p>Pre-primer: data in a database is stored on disk somewhere. In a SQL database, the data is organized into tables which have rows and columns. An index is a way to look up particular rows, based on the values of one or more columns, without having to scan through the whole table. Instead, you look up those values in the index, which tells you where to find the matching rows.</p>

<p>Index lookups are typically faster than full table scans because they're organized for fast searches on the indexed columns (usually using binary trees), and they're also generally smaller than the original data.</p>

<p>A unique index is an index that also imposes a constraint: that no two entries in the index can have the same values. It can be comprised of one column or many columns. If many columns, then the entire tuple of columns is used for determining uniqueness. There can be other columns in the table that are not part of the index; these don't affect the constraint.</p>

<p>Primary keys are a special case of unique index; we'll cover this in more detail later.</p>

<p>Unique indexes can be created in a CREATE TABLE statement like this 123123:</p>

<p><code>sql
CREATE TABLE user (
  username varchar(32),
  password char(32),
  unique (username)
);
</code></p>

<p>or using an ALTER TABLE statement like this:</p>

<p><code>sql
ALTER TABLE users ADD unique (username);
</code></p>

<h2>What does a unique constraint affect?</h2>

<p>A unique constraint prevents you from changing your data in a way that would result in having duplicate data in the index. For example, given the above 'user' table, the following will happen if we try to insert duplicate data:</p>

<p>```
mysql> INSERT INTO user VALUES ('brian', PASSWORD('asdf'));
Query OK, 1 row affected, 1 warning (0.04 sec)</p>

<p>mysql> INSERT INTO user VALUES ('brian', PASSWORD('asdfjkl'));
ERROR 1062 (23000): Duplicate entry 'brian' for key 'username'
```</p>

<p>or if we try to get duplicate data with an update:</p>

<p>```
mysql> INSERT INTO user VALUES('sherlock', PASSWORD('123456'));
Query OK, 1 row affected, 1 warning (0.00 sec)</p>

<p>mysql> UPDATE user SET username = 'brian' WHERE username = 'sherlock';
ERROR 1062 (23000): Duplicate entry 'brian' for key 'username'
```</p>

<p>So we can see that unique indexes are a great way to maintain consistency of our data at the database level. If two people try to sign up with the same username, for example, the database will reject it and return a duplicate key error.</p>

<h2>Taking it to the next level</h2>

<p>MySQL provides several commands, all variations of INSERT, that can take advantage of unique indexes by specifying what to do (instead of erroring) when the insert would result in a duplicate. These are best illustrated by example.</p>

<h3>INSERT ... ON DUPLICATE KEY UPDATE</h3>

<p>Let's say we're building a simple ad impression tracking system. Ads are served by web servers and the impression counts are tracked in a database. We just want to know the number of ad impressions each hour. So we make a table like this:</p>

<p><code>
CREATE TABLE hour_impression (
  hour int unsigned not null,  -- number of hours since unix epoch
  impressions int unsigned not null default 0,
  primary key(hour)
);
</code></p>

<p>Side note: here we're using <code>hour</code> as the primary key, rather than having an auto-increment primary key like before in the 'user' table. This guarantees that <code>hour</code> is unique (since primary keys are a subset of unique keys), and has a nice property of laying out the data on disk in hour-order.</p>

<p>A naive algorithm for recording each impression would be to:</p>

<ol>
<li>Check if a row already exists for the hour</li>
<li>If not: <code>INSERT INTO hour_impression (hour, impressions) VALUES (:hour, 1)</code></li>
<li>If so: <code>UPDATE hour_impression SET impressions = impressions + 1 WHERE hour = :hour</code></li>
</ol>


<p>But this exposes a race condition: what happens if two impressions happen at approximately the same time, on two different web servers? It's possible that both will try to INSERT, and the second one is going to fail (because of the unique constraint).</p>

<p>What we want to do is combine the above algorithm into a single step. This is what INSERT … ON DUPLICATE KEY UPDATE is for:</p>

<p><code>
INSERT INTO hour_impression (hour, impressions)
VALUES (379015, 1)
ON DUPLICATE KEY UPDATE impressions = impressions + 1
</code></p>

<p>Now that it's a single step, we can run as many of these statements in parallel as we want, and the database will take care of the concurrency issues for us. Sweet!</p>

<h3>INSERT IGNORE</h3>

<p>Now let's say instead of counting the number of impressions in each hour, we just want to know which minutes any impressions at all were shown. So we create a table like this:</p>

<p><code>
CREATE TABLE minute_impression (
  minute int unsigned not null,  -- number of minutes since the unix epoch
  primary key (minute)
);
</code></p>

<p>Similar to before, a naive algorithm for recording which minutes had any impressions would be to:</p>

<ol>
<li>Check if a row already exists for the minute</li>
<li>If so, do nothing</li>
<li>If not, <code>INSERT INTO minute_impression (minute) VALUES (:minute)</code></li>
</ol>


<p>This has the same kind of race condition as in the previous example. INSERT IGNORE exists to combine all of this into a single step:</p>

<p><code>
INSERT IGNORE INTO minute_impression (minute) VALUES (22740922)
</code></p>

<p>And as before, now we can run as many of these in parallel as we want and let the database take care of the concurrency.</p>

<h2>More tricks</h2>

<h3>REPLACE</h3>

<p>The opposite of INSERT IGNORE. Overwrites matching rows with the new data instead of discarding it.</p>

<h3>Nullable unique indexes</h3>

<p>Values in a unique index have to be unique, but there's an exception: NULLs don't count. For example, let's say you let people pick their username after signup. You might have table like:</p>

<p><code>
CREATE TABLE user (
  id int unsigned not null auto_increment,
  username varchar(32) default null,
  unique (username),
  primary key (id)
);
</code></p>

<p>You can have as many users as you like who haven't chosen a username (it'll be NULL) while still preventing multiple users from having the same username.</p>

<h3>VALUES() in the ON DUPLICATE KEY UPDATE clause</h3>

<p>You can insert multiple rows in a single INSERT … ON DUPLICATE KEY UPDATE statement, and the UPDATE rule will apply for each row that would've been a duplicate. In some cases you'll want the update statement to reflect the values of each particular row, and that's not possible to do by hardcoding them in the statement.</p>

<p>For example, let's return to the ad impression tracking problem from before, with this hour_impression table:</p>

<p><code>
CREATE TABLE hour_impression (
  hour int unsigned not null,  -- number of hours since unix epoch
  impressions int unsigned not null default 0,
  primary key(hour)
);
</code></p>

<p>But now instead of recording impressions one at a time, we're batching them so that each INSERT increments <code>impressions</code> by a value 1 or higher. If we insert one of these batches at a time, we can do:</p>

<p><code>
INSERT INTO hour_impression (hour, impressions)
VALUES (379015, 23)  -- 23 impressions during 12am 3/28/2013
ON DUPLICATE KEY UPDATE
impressions = impressions + 23
</code></p>

<p>If we want to insert multiple rows in the same statement, there's a problem -- the amount in the UPDATE clause is hardcoded. We can fix this using VALUES() to reference the value from the would-have-been-inserted row:</p>

<p><code>
INSERT INTO hour_impression (hour, impressions)
VALUES (379015, 23), (379015, 55)
ON DUPLICATE KEY UPDATE
impressions = impressions + VALUES(impressions)
</code></p>

<h2>Conclusion</h2>

<p>Unique indexes are useful when used alone and become incredibly powerful when used in combination with INSERT ... ON DUPLICATE KEY UPDATE and its variants. We make heavy use of this at <a href="https://rollbar.com">Rollbar</a> and it works great.</p>

<p>Questions? Corrections? Let me know in the comments.</p>

<h3>References</h3>

<ol>
<li><a href="http://dev.mysql.com/doc/refman/5.0/en/insert-on-duplicate.html">INSERT ... ON DUPLICATE KEY UPDATE syntax</a></li>
<li><a href="http://dev.mysql.com/doc/refman/5.0/en/insert.html">INSERT IGNORE syntax</a> (ctrl+f on the page)</li>
<li><a href="http://dev.mysql.com/doc/refman/5.0/en/replace.html">REPLACE syntax</a></li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using a Request Factory in Pyramid to write a little less code]]></title>
    <link href="https://rollbar.com/blog/post/2012/09/07/using-pyramid-request-factory-to-write-less-code/"/>
    <updated>2012-09-07T11:00:00-07:00</updated>
    <id>https://rollbar.com/blog/post/2012/09/07/using-pyramid-request-factory-to-write-less-code</id>
    <content type="html"><![CDATA[<p>At <a href="http://rollbar.com/">Rollbar.com</a>, we've been using <a href="http://www.pylonsproject.org/">Pyramid</a> as our web framework and have been pretty happy with it. It's lightweight and mostly stays out of our way.</p>

<p>Pyramid doesn't have a global request object that you can just import [1], so it makes you pass around <code>request</code> wherever you need it. That results in a lot of library code that looks like this:</p>

<p>```python</p>

<h1>lib/helpers.py</h1>

<p>def flash_success(request, body, title=''):</p>

<pre><code>request.session.flash({'body': body, 'title': title'})
</code></pre>

<p>```</p>

<p>and a lot of view code that looks like this:</p>

<p>```python</p>

<h1>views/auth.py</h1>

<p>@view_config(route_name='auth/login')
def login(request):</p>

<pre><code># (do the login...)
helpers.flash_success(request, "You're now logged in.")
# (redirect...)
</code></pre>

<p>```</p>

<p>That is, there ends up being a lot of function calls that pass <code>request</code> as their first argument. Wouldn't it be nicer if we could attach these functions as methods on <code>request</code> itself? That would save a few characters every time we call them, and let us stop thinking about whether <code>request</code> is the first or last argument. Pyramid facilitates this by letting us provide our own <a href="http://pyramid.readthedocs.org/en/latest/narr/hooks.html#changing-the-request-factory">Request Factory</a>:</p>

<p>```python
from pyramid.request import Request</p>

<p>class MyRequest(Request):</p>

<pre><code>def hello(self):
    print "hello!"
</code></pre>

<p>def main(global_config, **settings):</p>

<pre><code>config = Configurator(settings=settings, request_factory=MyRequest)
# ...
</code></pre>

<p>```</p>

<p>Now the <code>request</code> passed to our view methods, and everwhere else in our app, has our <code>hello</code> method.</p>

<p>So, what can we do with this that's actually useful? In our codebase, we have a few convenience methods to get data about the logged-in user, flash messages, and check if features are enabled.</p>

<p>Here it is, unedited, in its entirety:</p>

<p>```
class MoxRequest(pyramid.request.Request):</p>

<pre><code># logged-in-user access
@util.CachedAttribute
def user_id(self):
    from pyramid.security import authenticated_userid
    user_id = authenticated_userid(self)
    log.debug('authenticated user id: %r', user_id)
    return user_id

@util.CachedAttribute
def user(self):
    user_id = self.user_id
    if user_id:
        return model.User.get(user_id)
    return None

@util.CachedAttribute
def username(self):
    if self.user:
        return self.user.username
    else:
        return None

def gater_check(self, feature_name):
    return self.registry.settings.get('gater.%s' % feature_name) == 'on'

# flash methods
def flash_success(self, body, title=''):
    self._flash_message(body, title=title, queue='success')

def flash_info(self, body, title=''):
    self._flash_message(body, title=title, queue='info')

def flash_warning(self, body, title=''):
    self._flash_message(body, title=title, queue='warning')

def flash_error(self, body, title=''):
    self._flash_message(body, title=title, queue='error')

def _flash_message(self, body, title='', queue=''):
    self.session.flash({'title': title, 'body': body}, queue=queue)
</code></pre>

<p>```</p>

<p>This just sits in our top-level <code>__init__.py</code>, along with the <code>main()</code> entry point.</p>

<p>Notes: <code>@util.CachedAttribute</code> contains <a href="http://code.activestate.com/recipes/276643-caching-and-aliasing-with-descriptors/">this recipe</a>. "Mox" is an easy-to-type codename, named after <a href="http://www.summitpost.org/mox-peaks-from-red-face-mountain/690027">these mountains</a>.</p>

<p>[1] I'm still not sold on this, but I'm getting by. It arguably causes problems with testing and such, but it <em>is</em> pretty nice to magically <code>from flask import request</code>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Writing a simple deploy script with Fabric and @roles]]></title>
    <link href="https://rollbar.com/blog/post/2012/08/16/writing-a-simple-deploy-script-with-fabric-and-roles/"/>
    <updated>2012-08-16T11:52:00-07:00</updated>
    <id>https://rollbar.com/blog/post/2012/08/16/writing-a-simple-deploy-script-with-fabric-and-roles</id>
    <content type="html"><![CDATA[<p>I first heard about <a href="http://www.fabfile.org">Fabric</a> a couple years ago while at Lolapps and liked the idea of:</p>

<ul style="margin-left:40px;">
  <li>writing deployment and sysadmin scripts in a language other than Bash</li>
  <li>that language being Python, which we used everywhere else</li>
</ul>


<p>but we already had a huge swath of shell scripts that worked well (and truth be told, Bash isn’t really that bad). But now that we have at clean slate for <a href="https://rollbar.com">Rollbar</a>, Fabric it is.</p>

<p>I wanted a simple deployment script that would do the following:</p>

<ol style="margin-left:40px;">
  <li>check to make sure it’s running as the user "deploy" (since that's the user that has ssh keys set up and owns the code on the remote machines)</li>
  <li>for each webserver:
    <ol style="list-style:lower-alpha;margin-left:20px;">
      <li>git pull</li>
      <li>pip install -r requirements.txt</li>
      <li>in series, restart each web process</li>
    </ol>
  </li>
  <li>make an HTTP POST to our <a href="https://rollbar.com/docs/deploys/">deploys api</a> to record that the deploy completed successfully</li>
</ol>


<p>Here’s my first attempt:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span> (fabfile1.py)</span> <a href='/downloads/code/fabfile1.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">roles</span><span class="p">,</span> <span class="n">execute</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'><span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;web1&#39;</span><span class="p">,</span> <span class="s">&#39;web2&#39;</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
</span><span class='line'>    <span class="c"># pre-roll checks</span>
</span><span class='line'>    <span class="n">check_user</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># do the roll.</span>
</span><span class='line'>    <span class="n">update_and_restart</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># post-roll tasks</span>
</span><span class='line'>    <span class="n">rollbar_record_deploy</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">update_and_restart</span><span class="p">():</span>
</span><span class='line'>    <span class="n">code_dir</span> <span class="o">=</span> <span class="s">&#39;/home/deploy/www/mox&#39;</span>
</span><span class='line'>    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">code_dir</span><span class="p">):</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;git pull&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;pip install -r requirements.txt&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;supervisorctl restart web1&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;supervisorctl restart web2&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">check_user</span><span class="p">():</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;whoami&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;deploy&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;This command should be run as deploy. Run like: sudo -u deploy fab deploy&quot;</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">rollbar_record_deploy</span><span class="p">():</span>
</span><span class='line'>    <span class="c"># read access_token from production.ini</span>
</span><span class='line'>    <span class="n">access_token</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&quot;grep &#39;rollbar.access_token&#39; production.ini | sed &#39;s/^.* = //g&#39;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">environment</span> <span class="o">=</span> <span class="s">&#39;production&#39;</span>
</span><span class='line'>    <span class="n">local_username</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;whoami&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">revision</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;git log -n 1 --pretty=format:&quot;%H&quot;&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;https://api.rollbar.com/api/1/deploy/&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;access_token&#39;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;environment&#39;</span><span class="p">:</span> <span class="n">environment</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;local_username&#39;</span><span class="p">:</span> <span class="n">local_username</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;revision&#39;</span><span class="p">:</span> <span class="n">revision</span>
</span><span class='line'>    <span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Deploy recorded successfully&quot;</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Error recording deploy:&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Looks close-ish, right? It knows which hosts to deploy to, checks that it’s running as deploy, updates and restarts each host, and records the deploy. Here’s the output:</p>

<p>```
$ sudo -u deploy fab deploy
(env-mox)[brian@dev mox]$ sudo -u deploy fab deploy
[sudo] password for brian:
[web1] Executing task 'deploy'
[localhost] local: whoami
[web1] run: git pull
[web1] out: remote: Counting objects: 8, done.
[web1] out: remote: Compressing objects: 100% (4/4), done.
[web1] out: remote: Total 6 (delta 4), reused 4 (delta 2)
[web1] out: Unpacking objects: 100% (6/6), done.
[web1] out: From github.com:brianr/mox
[web1] out:    c731b57..1d365e0  master     -> origin/master
[web1] out: Updating c731b57..1d365e0
[web1] out: Fast-forward
[web1] out:  fabfile.py |    8 ++++----
[web1] out:  1 file changed, 4 insertions(+), 4 deletions(-)</p>

<p>[web1] run: pip install -r requirements.txt
[web1] out: Requirement already satisfied (use --upgrade to upgrade): Beaker==1.6.3 in /home/deploy/env-mox/lib/python2.7/site-packages (from -r requirements.txt (line 1))
<snip>
[web1] out: Cleaning up...</p>

<p>[web1] run: supervisorctl restart web1
[web1] out: web1: stopped
[web1] out: web1: started</p>

<p>[web1] run: supervisorctl restart web2
[web1] out: web2: stopped
[web1] out: web2: started</p>

<p>[localhost] local: grep 'rollbar.access_token' production.ini | sed 's/<sup>.*</sup> = //g'
[localhost] local: whoami
[localhost] local: git log -n 1 --pretty=format:"%H"
Deploy recorded successfully. Deploy id: 307
[web2] Executing task 'deploy'
[localhost] local: whoami
[web2] run: git pull
[web2] out: remote: Counting objects: 8, done.
[web2] out: remote: Compressing objects: 100% (4/4), done.
[web2] out: remote: Total 6 (delta 4), reused 4 (delta 2)
[web2] out: Unpacking objects: 100% (6/6), done.
[web2] out: From github.com:brianr/mox
[web2] out:    c731b57..1d365e0  master     -> origin/master
[web2] out: Updating c731b57..1d365e0
[web2] out: Fast-forward
[web2] out:  fabfile.py |    8 ++++----
[web2] out:  1 file changed, 4 insertions(+), 4 deletions(-)</p>

<p>[web2] run: pip install -r requirements.txt
[web2] out: Requirement already satisfied (use --upgrade to upgrade): Beaker==1.6.3 in /home/deploy/env-mox/lib/python2.7/site-packages (from -r requirements.txt (line 1))</p>

<p>[web2] out: Cleaning up...</p>

<p>[web2] run: supervisorctl restart web1
[web2] out: web1: stopped
[web2] out: web1: started</p>

<p>[web2] run: supervisorctl restart web2
[web2] out: web2: stopped
[web2] out: web2: started</p>

<p>[localhost] local: grep 'rollbar.access_token' production.ini | sed 's/<sup>.*</sup> = //g'
[localhost] local: whoami
[localhost] local: git log -n 1 --pretty=format:"%H"
Deploy recorded successfully. Deploy id: 308</p>

<p>Done.
Disconnecting from web2... done.
Disconnecting from web1... done.
```</p>

<p>Lots of good things happening. But it's doing the whole process -- <code>check_user</code>, <code>update_and_restart</code>, <code>rollbar_record_deploy</code> -- twice, once for each host. The duplicate <code>check_user</code> just slows things down, but the duplicate <code>rollbar_record_deploy</code> is going to mess with our deploy history, and it's only going to get worse as we add more servers.</p>

<p>Fabric's solution to this, described in their <a href="http://docs.fabfile.org/en/1.4.3/usage/execution.html">docs</a>, is "roles". We can map hosts to roles, then decorate tasks with which roles they apply to. Here we replace the <code>env.hosts</code> declaration with <code>env.roledefs</code>, decorate <code>update_and_restart</code> with <code>@roles</code>, and call <code>update_and_restart</code> with <code>execute</code> so that the <code>@roles</code> decorator is honored:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span> (fabfile2.py)</span> <a href='/downloads/code/fabfile2.py'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='py'><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">roles</span><span class="p">,</span> <span class="n">execute</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">requests</span>
</span><span class='line'>
</span><span class='line'><span class="n">env</span><span class="o">.</span><span class="n">roledefs</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;web&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;web1&#39;</span><span class="p">,</span> <span class="s">&#39;web2&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">deploy</span><span class="p">():</span>
</span><span class='line'>    <span class="c"># pre-roll checks</span>
</span><span class='line'>    <span class="n">check_user</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># do the roll.</span>
</span><span class='line'>    <span class="c"># execute() will call the passed-in function, honoring host/role decorators.</span>
</span><span class='line'>    <span class="n">execute</span><span class="p">(</span><span class="n">update_and_restart</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># post-roll tasks</span>
</span><span class='line'>    <span class="n">rollbar_record_deploy</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nd">@roles</span><span class="p">(</span><span class="s">&#39;web&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">update_and_restart</span><span class="p">():</span>
</span><span class='line'>    <span class="n">code_dir</span> <span class="o">=</span> <span class="s">&#39;/home/deploy/www/mox&#39;</span>
</span><span class='line'>    <span class="k">with</span> <span class="n">cd</span><span class="p">(</span><span class="n">code_dir</span><span class="p">):</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;git pull&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;pip install -r requirements.txt&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;supervisorctl restart web1&quot;</span><span class="p">)</span>
</span><span class='line'>        <span class="n">run</span><span class="p">(</span><span class="s">&quot;supervisorctl restart web2&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">check_user</span><span class="p">():</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;whoami&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;deploy&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;This command should be run as deploy. Run like: sudo -u deploy fab deploy&quot;</span>
</span><span class='line'>        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">rollbar_record_deploy</span><span class="p">():</span>
</span><span class='line'>    <span class="c"># read access_token from production.ini</span>
</span><span class='line'>    <span class="n">access_token</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&quot;grep &#39;rollbar.access_token&#39; production.ini | sed &#39;s/^.* = //g&#39;&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">environment</span> <span class="o">=</span> <span class="s">&#39;production&#39;</span>
</span><span class='line'>    <span class="n">local_username</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;whoami&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>    <span class="n">revision</span> <span class="o">=</span> <span class="n">local</span><span class="p">(</span><span class="s">&#39;git log -n 1 --pretty=format:&quot;%H&quot;&#39;</span><span class="p">,</span> <span class="n">capture</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s">&#39;https://api.rollbar.com/api/1/deploy/&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;access_token&#39;</span><span class="p">:</span> <span class="n">access_token</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;environment&#39;</span><span class="p">:</span> <span class="n">environment</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;local_username&#39;</span><span class="p">:</span> <span class="n">local_username</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;revision&#39;</span><span class="p">:</span> <span class="n">revision</span>
</span><span class='line'>    <span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Deploy recorded successfully&quot;</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Error recording deploy:&quot;</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Here's the output:</p>

<p>```
(env-mox)[brian@dev mox]$ sudo -u deploy fab deploy
[sudo] password for brian:
[localhost] local: whoami
[web1] Executing task 'update_and_restart'
[web1] run: git pull
[web1] out: Already up-to-date.</p>

<p>[web1] run: pip install -r requirements.txt
[web1] out: Requirement already satisfied (use --upgrade to upgrade): Beaker==1.6.3 in /home/deploy/env-mox/lib/python2.7/site-packages (from -r requirements.txt (line 1))
<snip>
[web1] out: Cleaning up...</p>

<p>[web1] run: supervisorctl restart web1
[web1] out: web1: stopped
[web1] out: web1: started</p>

<p>[web1] run: supervisorctl restart web2
[web1] out: web2: stopped
[web1] out: web2: started</p>

<p>[web2] Executing task 'update_and_restart'
[web2] run: git pull
[web2] out: Already up-to-date.</p>

<p>[web2] run: pip install -r requirements.txt
[web2] out: Requirement already satisfied (use --upgrade to upgrade): Beaker==1.6.3 in /home/deploy/env-mox/lib/python2.7/site-packages (from -r requirements.txt (line 1))</p>

<p>[web2] out: Cleaning up...</p>

<p>[web2] run: supervisorctl restart web1
[web2] out: web1: stopped
[web2] out: web1: started</p>

<p>[web2] run: supervisorctl restart web2
[web2] out: web2: stopped
[web2] out: web2: started</p>

<p>[localhost] local: grep 'rollbar.access_token' production.ini | sed 's/<sup>.*</sup> = //g'
[localhost] local: whoami
[localhost] local: git log -n 1 --pretty=format:"%H"
Deploy recorded successfully. Deploy id: 309</p>

<p>Done.
Disconnecting from web2... done.
Disconnecting from web1... done.
```</p>

<p>That's more like it. Since <code>env.hosts</code> is not set, the undecorated tasks just run locally (and only once), and the <code>@roles('web')</code>-decorated task runs for each web host.</p>
]]></content>
  </entry>
  
</feed>
