
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Rollbar - Blog - real-time error tracking for Rails, Python, PHP, Javascript, and Flash</title>
  <meta name="author" content="Rollbar, Inc.">

  
  <meta name="description" content="It&#8217;s pretty well known that every web app needs frontend JavaScript these days to provide the best possible user experience. You are probably &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  
  <link rel="canonical" href="https://rollbar.com/blog/">
  
  
  <link rel="publisher" href="https://plus.google.com/u/1/b/117853246165185436076/117853246165185436076/posts"/>
  
  <link href="/static/img/favicon.ico" rel="icon" type="image/png">
  <link href="/blog/stylesheets/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/stylesheets/custom.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/stylesheets/stylesheet.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/stylesheets/blog.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/blog/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/blog/javascripts/modernizr-2.0.js"></script>
  <script src="/blog/javascripts/ender.js"></script>
  <script src="/blog/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/blog/atom.xml" rel="alternate" title="Rollbar - Blog - real-time error tracking for Rails, Python, PHP, Javascript, and Flash" type="application/atom+xml">
  <script type="text/javascript">
    (function(c,a){window.mixpanel=a;var b,d,h,e;b=c.createElement("script");
    b.type="text/javascript";b.async=!0;b.src=("https:"===c.location.protocol?"https:":"http:")+
    '//cdn.mxpnl.com/libs/mixpanel-2.0.min.js';d=c.getElementsByTagName("script")[0];
    d.parentNode.insertBefore(b,d);a._i=[];a.init=function(b,c,f){function d(a,b){
    var c=b.split(".");2==c.length&&(a=a[c[0]],b=c[1]);a[b]=function(){a.push([b].concat(
    Array.prototype.slice.call(arguments,0)))}}var g=a;"undefined"!==typeof f?g=a[f]=[]:
    f="mixpanel";g.people=g.people||[];h=['disable','track','track_pageview','track_links',
    'track_forms','register','register_once','unregister','identify','name_tag',
    'set_config','people.set','people.increment'];for(e=0;e<h.length;e++)d(g,h[e]);
    a._i.push([b,c,f])};a.__SV=1.1;})(document,window.mixpanel||[]);
    mixpanel.init("00a701b73e44aa932686f370607c338e");
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-38870420-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>



</head>

<body   >
    <div class="container-fluid">
  <header class="row-fluid">
    <div class="container">
      <div class="span3">
        <h1><a href="/" class="logo"></a></h1>
      </div>
      <div class="span9">
        <ul class="nav nav-pills pull-right">
          <li><a href="/features/">Features</a></li>
          <li><a href="/pricing">Pricing</a></li>
          <li><a href="/docs/">Docs</a></li>
          <li><span><a href="/login/" class="btn">Log In</a></span></li>
          <li><span><a href="/signup/" class="btn btn-primary">Free Trial</a></span></li>
        </ul>
      </div>
    </div>
  </header>
</div>


    
    
    <div id="main-stage" class="container">
      <div id="content">
        <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/08/02/javascript-and-source-maps-in-a-django-app/">JavaScript and Source Maps in a Django App</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-02T11:40:00-07:00" pubdate data-updated="true">Aug 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&#8217;s pretty well known that every web app needs frontend JavaScript these days to provide the best possible user experience. You are probably going to have a bunch of JavaScript files that need to be loaded by your users for that to happen, and since we all care about performance, minifiying and compressing these files is an absolute must. But what happens when it comes time to debug issues in these minified files? Stack traces will more or less be completely useless. How do we solve this problem?</p>

<p>JavaScript source maps solve this problem. They allow you to map a point in a minified file back to the unminfied source, making it possible to actually identify and fix issues encountered in a production app environment.</p>

<p>Below I have outlined a simple guide for setting up source map generation and usage in a sample Django app. You&#8217;ll learn how generate source maps for minified files, debug errors that happen in these files, and also a quick overview of what&#8217;s required to get this working for your production environments.</p>

<h2>Local Debugging with Source Maps</h2>

<p>Say you have a simple Django app with the following directory structure:</p>

<pre><code>...
app/
    ...
    views.py
    static/
        js/
            site.js (containing various models and functionality used in your app)
            jquery.js (unminified)
            util.js
    templates/
        index.html
</code></pre>

<p><code>site.js</code> would have the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">aFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">b</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">App</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="nx">App</span><span class="p">.</span><span class="nx">errorCausingFunction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">aFunction</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>views.py</code> would just contain one view that rendered <code>index.html</code>, and here is how <code>index.html</code> would look like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>...
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;static/js/site.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;static/js/jquery.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;static/js/util.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>....
</span><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'>    <span class="nx">App</span><span class="p">.</span><span class="nx">errorCausingFunction</span><span class="p">();</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s minify. Start by installing UglifyJS2:</p>

<pre><code>npm install -g uglify-js
</code></pre>

<p>Here is an example command run from <code>app/</code> that will generate minified Javascript:</p>

<pre><code>uglifyjs static/js/site.js static/js/jquery.js static/js/util.js --output static/js/all.min.js
</code></pre>

<p>Here we are using uglifyjs to minify three JS files, <code>site.js</code>, <code>util.js</code> and <code>jquery.js</code>, into <code>all.min.js</code>.</p>

<p>Update your <code>index.html</code> to include only <code>all.min.js</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;static/js/all.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&#8217;s try navigating to <code>index.html</code> and seeing what happens:</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/stacktrace-minified-chrome.png"></p>

<p>Not the most helpful stack trace. All the line numbers are 1, and if this were a much larger file with more generic function/variable names, it would be completely useless in helping you debug where things went wrong.</p>

<p>Let&#8217;s introduce source map functionality to our app.</p>

<p>Modify your minification command to look like this:</p>

<pre><code>uglifyjs static/js/site.js static/js/jquery.js static/js/util.js --output static/js/all.min.js --source-map static/js/all.min.map --source-map-url /static/js/all.min.map
</code></pre>

<p>Here we are adding two new options, <code>--source-map</code> and <code>--source-map-url</code>. UglifyJS2 will now generate the resulting source map as <code>static/js/all.min.map</code>, and will append a comment to the end of the minified file containing the url to the source map on your website, in this case <code>/static/js/all.min.map</code>. Note, you may need to modify the comment in <code>all.min.map</code> to read <code>//#</code> instead of <code>//@</code>, as this is a <a href="https://groups.google.com/forum/#!topic/mozilla.dev.js-sourcemap/4uo7Z5nTfUY">recently new convention</a>.</p>

<p>Now navigate to your app in Chrome with Developer Tools open. If everything is set up right, Chrome will automatically translate the frames in the stack trace to the unminified equivalents, like so:</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/stacktrace-unminified-chrome.png"></p>

<p>Note that the filenames and line numbers now refer to the original source code, instead of the minified source.</p>

<h2>Production Debugging with Source Maps</h2>

<p>The above process is all fine and dandy for errors encountered on your local machine, but what if you want to keep track of errors encountered by your users in real-time?</p>

<p>Here at <a href="https://rollbar.com">Rollbar</a>, we have recently reworked our error processing pipeline to support the application of source maps on JavaScript errors. Here&#8217;s how you would get Rollbar hooked up and reporting from your production environment:</p>

<ol>
<li><p>Create a Rollbar account</p></li>
<li><p>Follow the instructions to insert the Rollbar Javascript notifier snippet into your base template</p></li>
<li><p>Modify the snippet configuration to signal that source maps should be used:</p></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">_rollbarParams</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ... other params ...</span>
</span><span class='line'>  <span class="c1">// set this to &#39;true&#39; to enable source map processing</span>
</span><span class='line'><span class="s2">&quot;client.javascript.source_map_enabled&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// provide the current code version, i.e. the git SHA of your javascript code.</span>
</span><span class='line'><span class="s2">&quot;client.javascript.code_version&quot;</span><span class="o">:</span> <span class="s2">&quot;bdd2b9241f791fc9f134fb3244b40d452d2d7e35&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Make sure your minified files link properly to publicly accessible source maps using the <code>sourceMappingURL</code> comment:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// ... minified js file contents ...</span>
</span><span class='line'><span class="c1">//# sourceMappingURL=&lt;url for source map&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, when your app sends Rollbar an error report, Rollbar will automatically attempt to download source maps defined in your minified files and apply them to stack frames located in these files.</p>

<p>Here is an example of the source map application process in action with an unminified stack trace that you would see in Rollbar:</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/stacktrace-unminified-rollbar.png"></p>

<p>Notice the unminified source filenames with relevant line and column numbers.</p>

<h2>Automating things</h2>

<p>It&#8217;s a bit annoying to have to minify everything every time you change one of your Javascript files. We have a small script set up here in our dev environments that uses <a href="https://pypi.python.org/pypi/MacFSEvents">macfsevents</a> to listen for Javascript file changes. Once such events occur, we check to see if only the Javascript files we care about are affected. If so, we run an <code>uglifyjs</code> command on all the Javascript files to generate minified sources and source maps.</p>

<p>You can even go one step further by making an API call to Rollbar to upload your source map as part of your deploy process. This API endpoint also accepts source file uploads for files referenced by the source map, giving us the ability to print out the unminified source code for each frame in the stack trace. For example:</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/stacktrace-unminified-rollbar-with-source.png"></p>

<p>Here&#8217;s a sample command you could use to upload a source map and source file to our API:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>curl https://api.rollbar.com/api/1/sourcemap <span class="se">\</span>
</span><span class='line'>-F <span class="nv">access_token</span><span class="o">=</span>aaaabbbbccccddddeeeeffff00001111 <span class="se">\</span>
</span><span class='line'>-F <span class="nv">version</span><span class="o">=</span>bdd2b9241f791fc9f134fb3244b40d452d2d7e35 <span class="se">\</span>
</span><span class='line'>-F <span class="nv">minified_url</span><span class="o">=</span>http://127.0.0.1:8005/static/js/all.min.js <span class="se">\</span>
</span><span class='line'>-F <span class="nv">source_map</span><span class="o">=</span>@app/static/js/all.min.map <span class="se">\</span>
</span><span class='line'>-F app/static/js/site.js<span class="o">=</span>@app/static/js/site.js
</span></code></pre></td></tr></table></div></figure>


<p>The last param is a mapping of source file path to actual source file contents. The path would need to match the one defined in your source map, generated by your minification tool.</p>

<h2>More info</h2>

<p>Check out the documentation for more info about integrating your <a href="https://rollbar.com/docs/notifier/rollbar.js/">JavaScript</a> and <a href="https://rollbar.com/docs/guides_sourcemaps/">source maps</a> with Rollbar. Rollbar also integrates with your Python, Rails, PHP and Node.js based backends.</p>

<p>Contact us at <a href="team@rollbar.com">team@rollbar.com</a> if you have any questions, and be sure to follow <a href="https://twitter.com/rollbar">@rollbar</a> for more updates regarding new releases!</p>
</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/07/25/debug-production-errors-in-minified-javascript-with-source-maps-and-rollbar/">Debug Production Errors in Minified JS with Source Maps and Rollbar</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-25T14:49:00-07:00" pubdate data-updated="true">Jul 25<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://rollbar.com">Rollbar</a> just got a much-requested feature: Source Maps support for Javascript. If you minify your Javascript code in production, this will make debugging production errors much easier. This feature is now live for all accounts.</p>

<h2>What Are Source Maps?</h2>

<p>If you minify your Javascript code (i.e. using <a href="https://github.com/mishoo/UglifyJS2">UglifyJS2</a> or the <a href="https://developers.google.com/closure/compiler/">Closure Compiler</a>), it gets harder to debug errors. Stack traces reference the line/column numbers in the minified code instead of the original source code.</p>

<p><a href="http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/">Source Maps</a> were designed to resolve this; they provide a mapping back from the minified line/column numbers to the original code. Chrome and Firefox have tools to use them in development, but what about errors that happen in production?</p>

<h2>Source Maps and Rollbar</h2>

<p>Rollbar can now map stack traces that reference minified code back to the original source files, lines, and column numbers. Here&#8217;s what a stack trace might have looked like before:</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/stacktrace-minified.png"></p>

<p>Here&#8217;s the de-minified version:</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/stacktrace-unminified.png"></p>

<p>We&#8217;ll also use the de-minified stack trace in our <a href="https://rollbar.com/docs/guides_grouping/">grouping algorithm</a>, which should result in more useful grouping.</p>

<h2>Getting this set up</h2>

<p>To get started, you&#8217;ll need to make a change to <code>_rollbarParams</code> in the on-page javascript snippet. Add the following two parameters:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">_rollbarParams</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ... existing params ...</span>
</span><span class='line'>  <span class="c1">// set this to &#39;true&#39; to enable source map processing</span>
</span><span class='line'>  <span class="s2">&quot;client.javascript.source_map_enabled&quot;</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="c1">// provide the current code version, i.e. the git SHA of your javascript code.</span>
</span><span class='line'>  <span class="s2">&quot;client.javascript.code_version&quot;</span><span class="o">:</span> <span class="s2">&quot;bdd2b9241f791fc9f134fb3244b40d452d2d7e35&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, either:
- Add a sourceMappingUrl comment at the end of your minified file to point to the source map
- Upload the source map (along with all source files) separately, as part of your deploy process</p>

<p>This second step is a bit more involved so please see our <a href="https://rollbar.com/docs/guides_sourcemaps/">docs</a> for more details.</p>

<h2>Caveats</h2>

<p>All of this relies on having a stack trace with line and column numbers. Unfortunately, browser support for column numbers is inconsistent. As of today, this will work in Chrome, Firefox, and IE10+, and only for caught errors reported like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="k">try</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">doSomething</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">_rollbar</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Uncaught errors (reported via window.onerror) don&#8217;t have column numbers in any browser we&#8217;re aware of, so they aren&#8217;t able to be de-obfuscated. For best results, catch all your exceptions so you don&#8217;t fall back to the top-level error handler.</p>

<p>Happy debugging and please don&#8217;t hesistate to contact us (<a href="team@rollbar.com">team@rollbar.com</a>) if you have any questions.</p>
</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/07/12/Async-nodejs-API-server-testing/">Async node.js API server testing</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-12T01:20:00-07:00" pubdate data-updated="true">Jul 12<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post is about how we built our test suite for our API server at <a href="http://rollbar.com/">Rollbar</a> and some of the tricks and gotchas we ran into along the way. We wanted to build a test suite that not only tested the API logic, but also the underlying code, namely the <a href="http://expressjs.com/">Express</a> and the <a href="http://www.senchalabs.org/connect/">Connect</a> middlewares we use. If our API server was going to break, we wanted to know before we deployed it to thousands of customers and millions of requests per day.</p>

<p>Testing is super important. If you don&#8217;t want to test, this probably won&#8217;t be very helpful or interesting.</p>

<h2>We use Vows. Why not Mocha?</h2>

<p><a href="http://visionmedia.github.io/mocha/">Mocha</a> is, by far, the most widely used testing framework for Node.js apps. So, why didn&#8217;t we use it? The two main reasons were that Vows was the first thing I found when Googling &#8220;nodejs async testing&#8221; and the other is that the syntax of Mocha tests felt like another language and less like code. Mocha tests are more readble but the benefit of readability was overshadowed by the need to remember all of these new, special-case methods that Mocha injects.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Mocha</span>
</span><span class='line'><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="mi">5</span><span class="p">).</span><span class="nx">should</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>vs</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">//Vows</span>
</span><span class='line'><span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>There&#8217;s something that bothered me about the former. I didn&#8217;t like how the library used a bunch of magic to enable something this small/strange.</p>

<p>Mocha has a lot of awesome features but none that were important enough for me to switch.</p>

<h2>A simple Vows test</h2>

<p>Vows works just as you&#8217;d expect it to, except when it doesn&#8217;t. More on that later…</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">vows</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vows&#39;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">assert</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">);</span>
</span><span class='line'><span class="nx">vows</span><span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;testmodule&#39;</span><span class="p">).</span><span class="nx">addBatch</span><span class="p">({</span>
</span><span class='line'>  <span class="s2">&quot;call username() with a valid user id&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">topic</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">username</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s2">&quot;and verify username is correct&quot;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">assert</span><span class="p">.</span><span class="nx">isNull</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">assert</span><span class="p">.</span><span class="nx">isString</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">assert</span><span class="p">.</span><span class="nx">equal</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="s2">&quot;cory&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}).</span><span class="kr">export</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="p">{</span><span class="nx">error</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above test will make sure that the function <code>username()</code> calls its callback with <code>(null, "cory")</code>.</p>

<p>Note that we use this.callback since everything is assumed to be async and we use <code>{error: false}</code> when we export the batch. More on those later.</p>

<p>Check out the Vows <a href="http://vowsjs.org/">website</a> for better examples.</p>

<h2>Useful design patterns (I swear this will be short)</h2>

<p>We&#8217;ve found a few idioms and conventions that have been super helpful. Without going too much into design patterns and architecture, here are a few tips that have made writing tests super-easy; almost enjoyable—almost.</p>

<h3>Separate your view logic from your API business logic</h3>

<p>Your server&#8217;s views should have one job, to marshall data from the request/socket/carrier pigeon and provide it to your API library.</p>

<p>Any error checking done in your views should be to make sure the types provided to your API library are correct.</p>

<h3>Make every function you write use a callback.</h3>

<p>This is super-important for refactoring and adding new features. If you find yourself wanting to add a feature that requires i/o into a code path that was assumed to be completely synchonous, you&#8217;ll need to refactor the hell our of your code to make it work. Don&#8217;t bother. Make everything take a callback. Embrace async!</p>

<h3>Make the first argument to <em>every</em> callback be an optional error.</h3>

<p>This is how the Node.js developers do it and I agree. It makes for a lot more boiler-plate code but it forces you to keep error handling in-mind when developing. Writing defensive code is more important than writing fewer lines of code.</p>

<p>This will also make testing much, much easier with Vows. How? Read on…</p>

<h2>Testing the API server, for reals</h2>

<p>Definitely write tests and exercise your API library directly but don&#8217;t stop there. Fork a process, start your API server up in it and start firing requests at it using Vows.</p>

<p>testcommon.js:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">exports</span><span class="p">.</span><span class="nx">initTestingAppChildProc</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">promise</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// ... Setup temporary config file</span>
</span><span class='line'>  <span class="c1">// ... Get path to your main app.js</span>
</span><span class='line'>  <span class="c1">// ... Initialize the api library</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// fork a child process to start the api server</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="nx">configPath</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">];</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">appProc</span> <span class="o">=</span> <span class="nx">fork</span><span class="p">(</span><span class="nx">appJsPath</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// This is used to tell if our API server died during its</span>
</span><span class='line'>  <span class="c1">// initialization.</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">pendingCallback</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">appProc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">message</span> <span class="o">==</span> <span class="s1">&#39;ready&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">pendingCallback</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// This is how we know our API server is ready to </span>
</span><span class='line'>      <span class="c1">// receive requests. The message is emitted in the</span>
</span><span class='line'>      <span class="c1">// API server once it&#39;s ready to receive requests.</span>
</span><span class='line'>      <span class="nx">promise</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">appProc</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">appProc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">signal</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">pendingCallback</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">msg</span> <span class="o">=</span> <span class="s1">&#39;child process exited before callback&#39;</span><span class="p">;</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">promise</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">msg</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>  <span class="nx">appProc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;SIGTERM&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">();</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our API server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// initialize the API and start the web server when it&#39;s ready</span>
</span><span class='line'><span class="nx">api</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;Could not initialize API: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="c1">// Start up the server</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">httpServer</span> <span class="o">=</span> <span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span> <span class="nx">host</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;API server is ready.&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">info</span><span class="p">(</span><span class="s1">&#39;Listening on &#39;</span> <span class="o">+</span> <span class="nx">host</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nx">port</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Use the &quot;ready&quot; message to signal that the server is ready.</span>
</span><span class='line'>      <span class="c1">// This is used by the test suite to wait for the api server</span>
</span><span class='line'>      <span class="c1">// process to start up before sending requests.</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">send</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">process</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;ready&#39;</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>tests/routes.project.js:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">vows</span><span class="p">.</span><span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;routes.project&#39;</span><span class="p">).</span><span class="nx">addBatch</span><span class="p">({</span>
</span><span class='line'>  <span class="c1">// Provides a reference to the api server child process</span>
</span><span class='line'>  <span class="s1">&#39;Start up an API server&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">topic</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">promise</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">events</span><span class="p">.</span><span class="nx">EventEmitter</span><span class="p">();</span>
</span><span class='line'>      <span class="nx">common</span><span class="p">.</span><span class="nx">initTestingAppChildProc</span><span class="p">(</span><span class="nx">config</span><span class="p">,</span> <span class="nx">promise</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">promise</span><span class="p">;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">teardown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">childProc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">;</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">shutdown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">api</span><span class="p">.</span><span class="nx">shutdown</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">childProc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">childProc</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;exit&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">sig</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">shutdown</span><span class="p">();</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>        <span class="nx">childProc</span><span class="p">.</span><span class="nx">kill</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">shutdown</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="s1">&#39;and get a valid project&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">topic</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">childProc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">common</span><span class="p">.</span><span class="nx">apiGet</span><span class="p">(</span><span class="nx">url</span><span class="p">(</span><span class="s1">&#39;api/1/project/&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="p">{</span><span class="nx">access_token</span><span class="o">:</span> <span class="nx">config</span><span class="p">.</span><span class="nx">test</span><span class="p">.</span><span class="nx">validEnabledReadAccessToken</span><span class="p">}),</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="s1">&#39;returns 200 OK&#39;</span><span class="o">:</span> <span class="nx">common</span><span class="p">.</span><span class="nx">assertStatus</span><span class="p">(</span><span class="mi">200</span><span class="p">),</span>
</span><span class='line'>      <span class="s1">&#39;returns JSON&#39;</span><span class="o">:</span> <span class="nx">common</span><span class="p">.</span><span class="nx">assertJsonContentType</span><span class="p">(),</span>
</span><span class='line'>      <span class="s1">&#39;fast local response time&#39;</span><span class="o">:</span> <span class="nx">common</span><span class="p">.</span><span class="nx">assertMaxResponseTime</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span>
</span><span class='line'>      <span class="s2">&quot;returns a valid api response&quot;</span><span class="o">:</span> <span class="nx">common</span><span class="p">.</span><span class="nx">assertValidApiResponse</span><span class="p">(),</span>
</span><span class='line'>      <span class="s2">&quot;has a result key in the JSON response&quot;</span><span class="o">:</span> <span class="nx">common</span><span class="p">.</span><span class="nx">assertJsonHasFields</span><span class="p">([</span><span class="s1">&#39;result&#39;</span><span class="p">]),</span>
</span><span class='line'>      <span class="s2">&quot;there&#39;s no api error&quot;</span><span class="o">:</span> <span class="nx">common</span><span class="p">.</span><span class="nx">assertNoApiError</span><span class="p">(),</span>
</span><span class='line'>      <span class="s1">&#39;all of the deploy fields are available&#39;</span><span class="o">:</span> <span class="nx">common</span><span class="p">.</span><span class="nx">assertJsonHasFields</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">projectFields</span><span class="p">(),</span>
</span><span class='line'>          <span class="s1">&#39;result&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="s1">&#39;cross-check account id with api.getAccount&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">topic</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">resp</span><span class="p">,</span> <span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">project</span> <span class="o">=</span> <span class="nx">body</span><span class="p">.</span><span class="nx">result</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">api</span><span class="p">.</span><span class="nx">getAccount</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">result</span><span class="p">.</span><span class="nx">account_id</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">callback</span><span class="p">);</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>        <span class="s1">&#39;verify the account is not null&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">account</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>          <span class="nx">assert</span><span class="p">.</span><span class="nx">isNull</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">assert</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">account</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}).</span><span class="kr">export</span><span class="p">(</span><span class="nx">module</span><span class="p">,</span> <span class="p">{</span><span class="nx">error</span><span class="o">:</span> <span class="kc">false</span><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is a lot happening in these tests.</p>

<ul>
<li>We use promises to notify our test when the API server is ready.

<ul>
<li>Documentation for using promises with Vows can be found <a href="http://vowsjs.org/#-writing-asynchronous-tests">here</a>.</li>
<li>I&#8217;m not completely on-board with the Promise design pattern but it seemed like the easiest way to get this working. Mostly, I needed an event to be fired when there was an error that caused the API server process to shut down.</li>
</ul>
</li>
<li>We use a Vows teardown function to shut down the API server process.</li>
<li>We use our API library to help test our API server.

<ul>
<li>We cross-check our API server&#8217;s response by using our API library directly.</li>
</ul>
</li>
<li>We use Vows macros for reusable tests on all API requests.

<ul>
<li>We also make use of Vows contexts even though there are none in this example.</li>
<li>Documentation for macros and contexts are <a href="http://vowsjs.org/#-macros">here</a>.</li>
</ul>
</li>
</ul>


<h2>Gotchas</h2>

<p>Never, ever, ever throw an uncaught exception in a Vows topic. It makes debugging impossible. I&#8217;ve wasted hours looking through my API library for a bug only to find that I had a silly bug in my topic.</p>

<p>Always use <code>export(module, {error: false})</code> in your Vows batches. This option is not really described in the Vows docs. I had to find it in the source. Basically, if you don&#8217;t have this, Vows will inspect the first argument to each test to see if it&#8217;s an error. Vows will potentially call your test functions with a different set of arguments depending on if the first parameter to the topic&#8217;s callback is an Error or not. It&#8217;s completely strange and magical and <a href="https://github.com/cloudhead/vows/pull/263">confusing</a>.</p>

<p>Testing without mock objects means that you need a real database which means you probably need real-ish data to test with. This is tough. We chose to maintain a DB SQL fixture that we have to update whenever the schema changes. It&#8217;s a bit clunky but it works. I&#8217;m open to suggestions for this if anyone knows of a better way.</p>

<h2>Wrapping up…</h2>

<p>We use <a href="http://circleci.com">CircleCI</a> to run all of these tests and are really happy with their service. It&#8217;s fast and easy to set up. Also, it has all of the systems that our API server uses like MySQL, Beanstalkd and Memcache pre-installed. This gets us closer to testing in a production environment than would otherwise be possible.</p>

<p>Hopefully you were able to glean some useful tips from our experience at <a href="http://rollbar.com/">Rollbar</a>. We love building tools for devs like you!</p>

<p>Add me on Twitter <a href="https://twitter.com/coryvirok">@coryvirok</a>.
Follow <a href="https://twitter.com/rollbar">@rollbar</a> for more updates.</p>

<h2>Moment of zen</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="err">✓</span> <span class="nx">OK</span> <span class="err">»</span> <span class="mi">497</span> <span class="nx">honored</span> <span class="p">(</span><span class="mf">33.232</span><span class="nx">s</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/05/29/may-release-roundup/">May Release Roundup</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-29T15:30:00-07:00" pubdate data-updated="true">May 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here&#8217;s a roundup of what&#8217;s new at Rollbar in the month of May.</p>

<h3>Big Features</h3>

<p>We revamped our notifications system, and added integrations with a bunch of new services. Rollbar now works with <a href="http://asana.com">Asana</a>, <a href="http://campfirenow.com/">Campfire</a>, <a href="https://flowdock.com">Flowdock</a>, <a href="https://github.com/features/projects/issues">Github Issues</a>, <a href="http://hipchat.com">Hipchat</a>, <a href="http://jira.com">JIRA</a>, <a href="http://pivotaltracker.com">Pivotal Tracker</a>, and <a href="http://trello.com">Trello</a>, as well as any arbitrary system via a <a href="http://www.webhooks.org/">Webhook</a>. See the <a href="https://rollbar.com/blog/post/2013/05/06/rules-engine-for-notifications-campfire-hipchat-jira-trello/">announcement blog post</a> for more details.</p>

<h3>Small Features</h3>

<ul>
<li><p>You can now customize how occurrences are grouped. This first release allows you to define rules of things that should always be grouped together. See the documentation: <a href="https://rollbar.com/docs/guides_custom_grouping/">Custom Grouping Rules</a>. An in-depth post on how to use this is coming soon.</p></li>
<li><p>There&#8217;s now a &#8220;Download CSV&#8221; link at the bottom of the Items page, which will let you download a CSV of what you see on the page. Note that this information is also available via our <a href="https://rollbar.com/docs/test_console/">API</a>.</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/download-csv.png"></p></li>
<li><p>You can now sort the Items page by Total Occurrences or Unique Users, in additon to Last Occurrence. Click on the column headers to change the sort.</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/item-list-sort.png"></p></li>
<li><p>Links to files in Github are now linked to the appropriate revision, when this information is available. We&#8217;ll use one of the following (trying each in order):</p>

<ul>
<li>the value of <code>server.sha</code></li>
<li>the value of <code>server.branch</code>, if it looks like a SHA</li>
<li>the revision from the last deploy before the first occurrence of the item</li>
</ul>
</li>
</ul>


<h3>Library Updates</h3>

<h4>Ruby</h4>

<p>We released <a href="https://github.com/rollbar/rollbar-gem">rollbar-gem</a> versions 0.9.11 through 0.9.14. The changes include a fix for use with Rails 4, a concurrency bugfix, better support for JSON requests, and the ability to include custom metadata with all reports. See the full <a href="https://github.com/rollbar/rollbar-gem/blob/master/CHANGELOG.md">changelog</a> for details. To upgrade, change the rollbar line in your Gemfile to:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">gem</span> <span class="s1">&#39;rollbar&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 0.9.14&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We also contributed a fix to <a href="https://github.com/CrowdFlower/resque-rollbar">resque-rollbar</a> to force use of synchronous mode when reporting Resque failures (instead of async mode, which doesn&#8217;t play nicely with Resque).</p>

<h4>Python</h4>

<p><a href="https://github.com/rollbar/pyrollbar">pyrollbar</a> gained a feature and now at version 0.5.7. See the <a href="https://github.com/rollbar/pyrollbar/blob/master/CHANGELOG.md">changelog</a> for details.</p>

<h3>Bug Fixes</h3>

<ul>
<li>Fixed an issue where pressing the back button would sometimes cause Chrome to render one of our JSON responses as if it were HTML</li>
<li>Fixed a bug where removed email addresses could not be re-added</li>
</ul>


<h3>Documentation Updates</h3>

<ul>
<li>Added guide on how our <a href="https://rollbar.com/docs/guides_grouping/">grouping algorithm</a> works.</li>
<li>Cleaned up our <a href="https://rollbar.com/docs/api_items/">Items API Reference</a> and fixed a few outdated parts</li>
</ul>


<p>More is on the way. Stay tuned! And don&#8217;t forget to send us any feedback: <a href="mailto:team@rollbar.com">team@rollbar.com</a> &mdash; we love hearing from you.</p>
</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/05/06/rules-engine-for-notifications-campfire-hipchat-jira-trello/">Rules Engine for Notifications, Plus Integrations with Campfire, Hipchat, JIRA, and Trello</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-06T21:30:00-07:00" pubdate data-updated="true">May 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we&#8217;re revamping the model for defining what you want to be notified about from <a href="https://rollbar.com">Rollbar</a>. Rollbar now integrates with <a href="http://asana.com">Asana</a>, <a href="http://campfirenow.com/">Campfire</a>, <a href="https://github.com/features/projects/issues">Github Issues</a>, <a href="http://hipchat.com">Hipchat</a>, <a href="http://jira.com">JIRA</a>, <a href="http://pivotaltracker.com">Pivotal Tracker</a>, and <a href="http://trello.com">Trello</a>, as well as any arbitrary system via a <a href="http://www.webhooks.org/">Webhook</a>.</p>

<h2>New Integration Channels</h2>

<p>In addition to our existing channels (Email, Asana, Github Issues, Pivotal Tracker, and Webhook), we&#8217;re launching support for four more: Campfire, Hipchat, JIRA, and Trello. You can set up all of this in Settings -> Notifications.</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/integration-channels.png"></p>

<h2>Notification Rules Engine</h2>

<p>Notifications are now configured per-project (instead of per-user-per-project), using a trigger-action model. There are triggers for the following events:</p>

<ul>
<li>New Item (first occurrence of a new issue)</li>
<li>Reactivated Item (a previously resolved issue has occurred again)</li>
<li>10<sup>nth</sup> Occurrence (an issue has occurred for the 10th, 100th, etc. time)</li>
<li>Resolved Item (an item has been resolved by hand)</li>
<li>Reopened Item (an item has been reopened by hand)</li>
<li>Post-deploy (you&#8217;ve notified us that you deployed a new release)</li>
</ul>


<p>Corresponding actions are available for most actions in most channels. If it would make sense, it probably exists.</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/rules-engine.png"></p>

<p>Most actions can be configured as you&#8217;d expect (i.e. set which teams should receive an email, or which user to assign JIRA issues to).</p>

<p>Item-related triggers can be filtered by environment, level, title (exception class+message), and filename. Deploy triggers can be filtered by environment and comment. Our underlying tech supports much more than the UI exposes, so let us know what other filters you&#8217;d like to see.</p>

<h2>Migration for existing customers</h2>

<p>We&#8217;ve migrated existing customers&#8217; settings to the new system, but there were a few aspects that didn&#8217;t map very well (i.e. per-user-per-project settings). We hope the new system is easier to use for most use-cases and still workable for complex setups, but let us know if there&#8217;s something you are having trouble doing.</p>

<h2>Questions? Feedback?</h2>

<p>Let us know if you have any questions about how to get the notifications you want. We look forward to your feedback. What other integrations do you want? Let us know in the comments, or email us at <a href="mailto:team@rollbar.com">team@rollbar.com</a>.</p>
</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/03/29/using-unique-indexes-for-fun-and-profit/">Taking UNIQUE indexes to the next level</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-29T09:15:00-07:00" pubdate data-updated="true">Mar 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You&#8217;ve probably seen unique constraints somewhere &#8211; either in Rails&#8217; <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#uniqueness"><code>validates :uniqueness</code></a>, Django&#8217;s <a href="https://docs.djangoproject.com/en/dev/ref/models/fields/#unique"><code>Field.unique</code></a>, or a raw SQL <a href="http://dev.mysql.com/doc/refman/5.5/en/create-index.html">table definition</a>. The basic function of unique constraints (preventing duplicate data from being inserted) is nice, but they&#8217;re so much more powerful than that. When you write INSERT or REPLACE statements that rely on them, you can do some pretty cool (and efficient) things that you would&#8217;ve had to do multiple queries for otherwise.</p>

<p>This post covers unique indexes in MySQL 5.5. Other versions of MySQL are similar. I&#8217;m not sure about Postgres or other relational databases but presume they&#8217;re similar-ish as well.</p>

<h2>Primer: what is a unique index?</h2>

<p>Pre-primer: data in a database is stored on disk somewhere. In a SQL database, the data is organized into tables which have rows and columns. An index is a way to look up particular rows, based on the values of one or more columns, without having to scan through the whole table. Instead, you look up those values in the index, which tells you where to find the matching rows.</p>

<p>Index lookups are typically faster than full table scans because they&#8217;re organized for fast searches on the indexed columns (usually using binary trees), and they&#8217;re also generally smaller than the original data.</p>

<p>A unique index is an index that also imposes a constraint: that no two entries in the index can have the same values. It can be comprised of one column or many columns. If many columns, then the entire tuple of columns is used for determining uniqueness. There can be other columns in the table that are not part of the index; these don&#8217;t affect the constraint.</p>

<p>Primary keys are a special case of unique index; we&#8217;ll cover this in more detail later.</p>

<p>Unique indexes can be created in a CREATE TABLE statement like this 123123:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">user</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
</span><span class='line'>  <span class="n">password</span> <span class="nb">char</span><span class="p">(</span><span class="mi">32</span><span class="p">),</span>
</span><span class='line'>  <span class="k">unique</span> <span class="p">(</span><span class="n">username</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>or using an ALTER TABLE statement like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="k">ADD</span> <span class="k">unique</span> <span class="p">(</span><span class="n">username</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h2>What does a unique constraint affect?</h2>

<p>A unique constraint prevents you from changing your data in a way that would result in having duplicate data in the index. For example, given the above &#8216;user&#8217; table, the following will happen if we try to insert duplicate data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">user</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;brian&#39;</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">(</span><span class="s1">&#39;asdf&#39;</span><span class="p">));</span>
</span><span class='line'><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span><span class="p">,</span> <span class="mi">1</span> <span class="n">warning</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">04</span> <span class="n">sec</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">user</span> <span class="k">VALUES</span> <span class="p">(</span><span class="s1">&#39;brian&#39;</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">(</span><span class="s1">&#39;asdfjkl&#39;</span><span class="p">));</span>
</span><span class='line'><span class="n">ERROR</span> <span class="mi">1062</span> <span class="p">(</span><span class="mi">23000</span><span class="p">):</span> <span class="n">Duplicate</span> <span class="n">entry</span> <span class="s1">&#39;brian&#39;</span> <span class="k">for</span> <span class="k">key</span> <span class="s1">&#39;username&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>or if we try to get duplicate data with an update:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">INSERT</span> <span class="k">INTO</span> <span class="k">user</span> <span class="k">VALUES</span><span class="p">(</span><span class="s1">&#39;sherlock&#39;</span><span class="p">,</span> <span class="n">PASSWORD</span><span class="p">(</span><span class="s1">&#39;123456&#39;</span><span class="p">));</span>
</span><span class='line'><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="k">row</span> <span class="n">affected</span><span class="p">,</span> <span class="mi">1</span> <span class="n">warning</span> <span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="n">sec</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">UPDATE</span> <span class="k">user</span> <span class="k">SET</span> <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;brian&#39;</span> <span class="k">WHERE</span> <span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;sherlock&#39;</span><span class="p">;</span>
</span><span class='line'><span class="n">ERROR</span> <span class="mi">1062</span> <span class="p">(</span><span class="mi">23000</span><span class="p">):</span> <span class="n">Duplicate</span> <span class="n">entry</span> <span class="s1">&#39;brian&#39;</span> <span class="k">for</span> <span class="k">key</span> <span class="s1">&#39;username&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>So we can see that unique indexes are a great way to maintain consistency of our data at the database level. If two people try to sign up with the same username, for example, the database will reject it and return a duplicate key error.</p>

<h2>Taking it to the next level</h2>

<p>MySQL provides several commands, all variations of INSERT, that can take advantage of unique indexes by specifying what to do (instead of erroring) when the insert would result in a duplicate. These are best illustrated by example.</p>

<h3>INSERT &#8230; ON DUPLICATE KEY UPDATE</h3>

<p>Let&#8217;s say we&#8217;re building a simple ad impression tracking system. Ads are served by web servers and the impression counts are tracked in a database. We just want to know the number of ad impressions each hour. So we make a table like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">hour_impression</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">hour</span> <span class="nb">int</span> <span class="n">unsigned</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>  <span class="c1">-- number of hours since unix epoch</span>
</span><span class='line'>  <span class="n">impressions</span> <span class="nb">int</span> <span class="n">unsigned</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="k">primary</span> <span class="k">key</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Side note: here we&#8217;re using <code>hour</code> as the primary key, rather than having an auto-increment primary key like before in the &#8216;user&#8217; table. This guarantees that <code>hour</code> is unique (since primary keys are a subset of unique keys), and has a nice property of laying out the data on disk in hour-order.</p>

<p>A naive algorithm for recording each impression would be to:</p>

<ol>
<li>Check if a row already exists for the hour</li>
<li>If not: <code>INSERT INTO hour_impression (hour, impressions) VALUES (:hour, 1)</code></li>
<li>If so: <code>UPDATE hour_impression SET impressions = impressions + 1 WHERE hour = :hour</code></li>
</ol>


<p>But this exposes a race condition: what happens if two impressions happen at approximately the same time, on two different web servers? It&#8217;s possible that both will try to INSERT, and the second one is going to fail (because of the unique constraint).</p>

<p>What we want to do is combine the above algorithm into a single step. This is what INSERT … ON DUPLICATE KEY UPDATE is for:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">hour_impression</span> <span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">impressions</span><span class="p">)</span>
</span><span class='line'><span class="k">VALUES</span> <span class="p">(</span><span class="mi">379015</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'><span class="k">ON</span> <span class="n">DUPLICATE</span> <span class="k">KEY</span> <span class="k">UPDATE</span> <span class="n">impressions</span> <span class="o">=</span> <span class="n">impressions</span> <span class="o">+</span> <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that it&#8217;s a single step, we can run as many of these statements in parallel as we want, and the database will take care of the concurrency issues for us. Sweet!</p>

<h3>INSERT IGNORE</h3>

<p>Now let&#8217;s say instead of counting the number of impressions in each hour, we just want to know which minutes any impressions at all were shown. So we create a table like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">minute_impression</span> <span class="p">(</span>
</span><span class='line'>  <span class="k">minute</span> <span class="nb">int</span> <span class="n">unsigned</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>  <span class="c1">-- number of minutes since the unix epoch</span>
</span><span class='line'>  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="k">minute</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Similar to before, a naive algorithm for recording which minutes had any impressions would be to:</p>

<ol>
<li>Check if a row already exists for the minute</li>
<li>If so, do nothing</li>
<li>If not, <code>INSERT INTO minute_impression (minute) VALUES (:minute)</code></li>
</ol>


<p>This has the same kind of race condition as in the previous example. INSERT IGNORE exists to combine all of this into a single step:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">IGNORE</span> <span class="k">INTO</span> <span class="n">minute_impression</span> <span class="p">(</span><span class="k">minute</span><span class="p">)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">22740922</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>And as before, now we can run as many of these in parallel as we want and let the database take care of the concurrency.</p>

<h2>More tricks</h2>

<h3>REPLACE</h3>

<p>The opposite of INSERT IGNORE. Overwrites matching rows with the new data instead of discarding it.</p>

<h3>Nullable unique indexes</h3>

<p>Values in a unique index have to be unique, but there&#8217;s an exception: NULLs don&#8217;t count. For example, let&#8217;s say you let people pick their username after signup. You might have table like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="k">user</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">id</span> <span class="nb">int</span> <span class="n">unsigned</span> <span class="k">not</span> <span class="k">null</span> <span class="n">auto_increment</span><span class="p">,</span>
</span><span class='line'>  <span class="n">username</span> <span class="nb">varchar</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span> <span class="k">default</span> <span class="k">null</span><span class="p">,</span>
</span><span class='line'>  <span class="k">unique</span> <span class="p">(</span><span class="n">username</span><span class="p">),</span>
</span><span class='line'>  <span class="k">primary</span> <span class="k">key</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can have as many users as you like who haven&#8217;t chosen a username (it&#8217;ll be NULL) while still preventing multiple users from having the same username.</p>

<h3>VALUES() in the ON DUPLICATE KEY UPDATE clause</h3>

<p>You can insert multiple rows in a single INSERT … ON DUPLICATE KEY UPDATE statement, and the UPDATE rule will apply for each row that would&#8217;ve been a duplicate. In some cases you&#8217;ll want the update statement to reflect the values of each particular row, and that&#8217;s not possible to do by hardcoding them in the statement.</p>

<p>For example, let&#8217;s return to the ad impression tracking problem from before, with this hour_impression table:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">hour_impression</span> <span class="p">(</span>
</span><span class='line'>  <span class="n">hour</span> <span class="nb">int</span> <span class="n">unsigned</span> <span class="k">not</span> <span class="k">null</span><span class="p">,</span>  <span class="c1">-- number of hours since unix epoch</span>
</span><span class='line'>  <span class="n">impressions</span> <span class="nb">int</span> <span class="n">unsigned</span> <span class="k">not</span> <span class="k">null</span> <span class="k">default</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>  <span class="k">primary</span> <span class="k">key</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span>
</span><span class='line'><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>But now instead of recording impressions one at a time, we&#8217;re batching them so that each INSERT increments <code>impressions</code> by a value 1 or higher. If we insert one of these batches at a time, we can do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">hour_impression</span> <span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">impressions</span><span class="p">)</span>
</span><span class='line'><span class="k">VALUES</span> <span class="p">(</span><span class="mi">379015</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>  <span class="c1">-- 23 impressions during 12am 3/28/2013</span>
</span><span class='line'><span class="k">ON</span> <span class="n">DUPLICATE</span> <span class="k">KEY</span> <span class="k">UPDATE</span>
</span><span class='line'><span class="n">impressions</span> <span class="o">=</span> <span class="n">impressions</span> <span class="o">+</span> <span class="mi">23</span>
</span></code></pre></td></tr></table></div></figure>


<p>If we want to insert multiple rows in the same statement, there&#8217;s a problem &#8211; the amount in the UPDATE clause is hardcoded. We can fix this using VALUES() to reference the value from the would-have-been-inserted row:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">hour_impression</span> <span class="p">(</span><span class="n">hour</span><span class="p">,</span> <span class="n">impressions</span><span class="p">)</span>
</span><span class='line'><span class="k">VALUES</span> <span class="p">(</span><span class="mi">379015</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="p">(</span><span class="mi">379015</span><span class="p">,</span> <span class="mi">55</span><span class="p">)</span>
</span><span class='line'><span class="k">ON</span> <span class="n">DUPLICATE</span> <span class="k">KEY</span> <span class="k">UPDATE</span>
</span><span class='line'><span class="n">impressions</span> <span class="o">=</span> <span class="n">impressions</span> <span class="o">+</span> <span class="k">VALUES</span><span class="p">(</span><span class="n">impressions</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Unique indexes are useful when used alone and become incredibly powerful when used in combination with INSERT &#8230; ON DUPLICATE KEY UPDATE and its variants. We make heavy use of this at <a href="https://rollbar.com">Rollbar</a> and it works great.</p>

<p>Questions? Corrections? Let me know in the comments.</p>

<h3>References</h3>

<ol>
<li><a href="http://dev.mysql.com/doc/refman/5.0/en/insert-on-duplicate.html">INSERT &#8230; ON DUPLICATE KEY UPDATE syntax</a></li>
<li><a href="http://dev.mysql.com/doc/refman/5.0/en/insert.html">INSERT IGNORE syntax</a> (ctrl+f on the page)</li>
<li><a href="http://dev.mysql.com/doc/refman/5.0/en/replace.html">REPLACE syntax</a></li>
</ol>

</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/03/21/improved-grouping-for-javascript-errors/">Improved grouping for Javascript errors</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-21T16:14:00-07:00" pubdate data-updated="true">Mar 21<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We&#8217;ve released an updated to how Javascript errors are grouped in Rollbar. The new update does a better job of separating different errors into different groups (&#8220;Items&#8221; in Rollbar parlance) while still recognizing the same issue in different browsers as the same. It&#8217;s now enabled for all new projects. Existing projects can enable it on the Migrations tab in Settings.</p>

<p>Now the longer version&#8230;</p>

<p>First some background: by default, exceptions in Rollbar are grouped using their stack traces. We take all of the filenames and method names in all of the stack frames, plus the exception class name, apply a number of heuristics to normalize them, and then combine everything together and take a sha1 hash. The result is a 40-character string used as the &#8220;fingerprint&#8221;; occurrences with matching fingerprints that also have the same project, environment, and platform are grouped together. The fingerprint can also be <a href="https://rollbar.com/docs/api_items/">overridden at the API level</a> for custom grouping.</p>

<p>This generally works pretty well:</p>

<ul>
<li>Omitting the line numbers from stack frames means groups persist across code changes elsewhere in the file.</li>
<li>Using the whole stack trace, instead of just the very last frame, avoids conflating unrelated issues that happen to cause an exception on the same line of code.</li>
<li>Using just the exception class, instead of also the message, avoids including data in the fingerprint, and when we have a nice, long stack trace, that&#8217;s usually enough uniqueness.</li>
</ul>


<p>Javascript uncaught errors are a different story though. They&#8217;re reported through <a href="https://developer.mozilla.org/en-US/docs/DOM/window.onerror">window.onerror</a>, which luckily is supported in all major browsers but doesn&#8217;t provide a lot of context: only the error message, filename, and line number. The Rollbar <a href="https://rollbar.com/docs/items_js/">javascript library</a> converts this into a stack trace with a single frame (using the filename and line number), and parses the error message to get a semblance of class and message.</p>

<p>The problem with this approach has been that since the grouping algorithm only uses filenames (not line numbers), there&#8217;s only one stack frame, since it only uses the exception class name (not message), there isn&#8217;t a whole lot of uniqueness. The updated algorithm improves this dramatically. Here&#8217;s how it works:</p>

<ol>
<li>There aren&#8217;t <em>that</em> many different kinds of Javascript errors. We&#8217;ve built up a database of the error messages generated by all of them, in all major browsers.</li>
<li>When we process an error, we try to match it against the patterns we know about. Several of the patterns have data in them; for some of the patterns, we keep the data (i.e. if it&#8217;s a variable name), and in others we discard it (i.e. if it&#8217;s an out-of-range precision value).</li>
<li>If we aren&#8217;t able to match any of the known patterns, we fall back to the old algorithm.</li>
</ol>


<p>We&#8217;ve been using this internally for the past couple weeks and so far it feels much better. A caveat: our pattern database currently is English-only, so errors from end-users with their language preferences set otherwise will be grouped using the old algorithm.</p>

<p>The new algorithm is now enabled for all newly-created projects. We aren&#8217;t automatically turning it on for old projects because none of the new groups will map to old groups; this will be a one-time event but could result in a lot of notifications and we don&#8217;t want to force the change. To enable it for an existing project, find the Migrations tab in the Settings for your project, and check the box next to &#8220;Browser JS Occurrence Grouping V2&#8221;.</p>

<p>Any questions? Let us know in the comments.</p>

<p><em>Rollbar collects and analyzes errors so you can find and fix them faster. <a href="https://rollbar.com/signup">Create a free account</a> to get started today.</em></p>
</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/02/26/rollbar-notifier-upgrades/">Upgrading to the new Rollbar notifier libraries</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-26T17:25:00-08:00" pubdate data-updated="true">Feb 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>We&#8217;ve updated all of our notifier library repositories to match the name change to Rollbar today. The old Ratchet.io repos have been deprecated and all further development will continue on the respective Rollbar versions.</p>

<p>Please note that the <code>submit.ratchet.io</code> endpoint and the existing libraries will continue to work for the indefinite future, so you don&#8217;t have to do anything right now. But we do recommend upgrading to take advantage of future updates.</p>

<p>Upgrading <em>should</em> be seamless and quick. Please contact <a href="mailto:support@rollbar.com">support@rollbar.com</a> if you run into any issues.</p>

<p>Here are links to the upgrade instructions for each:</p>

<ul>
<li><p>Browser JS - update the JS snippet used on your site to the version shown <a href="http://rollbar.com/docs/">here</a></p></li>
<li><p><a href="https://github.com/rollbar/pyrollbar/blob/master/UPGRADE_FROM_RATCHET.md">pyratchet</a></p></li>
<li><p><a href="https://github.com/rollbar/rollbar-gem/blob/master/UPGRADE_FROM_RATCHET.md">ratchetio-gem</a></p></li>
<li><p><a href="https://github.com/rollbar/rollbar-php/blob/master/UPGRADE_FROM_RATCHET.md">ratchetio-php</a></p></li>
<li><p><a href="https://github.com/rollbar/rollbar-agent/blob/master/UPGRADE_FROM_RATCHET.md">ratchet-agent</a></p></li>
<li><p><a href="https://github.com/rollbar/node_rollbar/blob/master/UPGRADE_FROM_RATCHET.md">node_ratchet</a></p></li>
<li><p><a href="https://github.com/rollbar/flash_rollbar/blob/master/UPGRADE_FROM_RATCHET.md">flash_ratchet</a></p></li>
</ul>

</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/02/26/rollbar-launch-and-initial-funding/">Rollbar launches, raises initial funding</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-26T12:15:00-08:00" pubdate data-updated="true">Feb 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today we’re excited to announce the public launch of Rollbar. Rollbar tracks and analyzes errors in production applications, helping dev and ops teams diagnose and fix them.</p>

<h3>Platform-agnostic API</h3>

<p>Anything that can speak JSON and HTTP can talk to Rollbar. Our API accepts raw &#8220;items&#8221; (errors, exceptions, and log messages) and deploys as inputs, and aggregated items, occurrences, and deploys as outputs. We provide official libraries for Ruby, Python, PHP, Node.js, Javascript, and Flash; or you can <a href="https://rollbar.com/docs/api_items/">roll your own</a>.</p>

<h3>Severity levels</h3>

<p>Just because something raises an exception, doesn&#8217;t mean it should be treated as an &#8220;error&#8221;. Rollbar lets you utilize five severity levels (from &#8220;debug&#8221; to &#8220;critical&#8221;) to control visibility and notifications. Severity can be set in your code, or after-the-fact in the Rollbar interface.</p>

<h3>Track users through your stack</h3>

<p>Person tracking helps you provide great customer support by emailing affected users when you fix an error they hit. Or see the history for a particular user and link customer error reports to code problems, client- and server-side.</p>

<h3>So much more</h3>

<p>API endpoints on 3 continents. Resolving and reactivations. Real-time notifications for new issues. Graphs everywhere. Deploy tracking. Search by title, host, file, context, date, severity, status. Replay an issue by pressing a button. SSL everywhere. Github, Asana, and Pivotal Tracker integration.</p>

<p>We&#8217;ve built many of the pieces our beta customers have needed, and we really think you&#8217;re going to like it. <a href="https://rollbar.com/signup/">Start a free trial now</a>, or see <a href="https://rollbar.com/pricing">pricing</a>, <a href="https://rollbar.com/features/">features</a>, or <a href="https://rollbar.com/docs/">docs</a>.</p>

<h3>More firepower</h3>

<p>We&#8217;re also excited to announce that we&#8217;ve raised an initial round of funding from some of the smartest people in the business. Mike Hirshland (Resolute.vc), Hiten Shah (KISSmetrics), and Arjun Sethi participated in the round. This funding gives us some extra firepower to grow the team and bring our vision to life.</p>

<p>We’re really excited and can’t wait to keep making Rollbar better!</p>

<p>Brian, Cory, and Sergei</p>
</div>
  
  


    </article>
    <hr>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/post/2013/01/11/post-mortem-from-last-nights-outage/">Post-mortem from last night&#8217;s outage</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-11T15:57:00-08:00" pubdate data-updated="true">Jan 11<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p><em>Tl;dr: from about 9:30pm to 12:30am last night, our website was unreachable and we weren&#8217;t sending out any notifications. Our API stayed up nearly the whole time thanks to an automatic failover.</em></p></blockquote>

<p>We had our first major outage last night. We want to apologize to all of our customers for this outage, and we&#8217;re going to continue to work to make the <a href="http://rollbar.com">Rollbar.com</a> service stable, reliable, and performant.</p>

<p>What follows is a timeline of events, and a summary of what went wrong, what went right, and what we&#8217;re doing to address what went wrong.</p>

<h2>Background</h2>

<p>First some background: our infrastructure is currently hosted at Softlayer and layed out like this (simplified):</p>

<p><img src="https://d37gvrvc0wt4s1.cloudfront.net/static/img/blog/infrastructurediagram.png"></p>

<p>That is:</p>

<ul>
<li>our primary cluster of servers is in San Jose</li>
<li>all web traffic (rollbar.com / www.rollbar.com) is handled by lb2</li>
<li>all API traffic (api.rollbar.com) is handled by lb1</li>
<li>lb3 (in Singapore) and lb4 (Amsterdam) are ready to go but not in use yet (more on this below), providing failover and faster API response times to customers outside of the Americas.</li>
</ul>


<p>We&#8217;ve been in the process of setting up lb3 and lb4, along with some <a href="http://dyn.com/dns/dynect-managed-dns/">fancy DNS functionality</a> from Dyn, to provide redundancy and faster response times to our customers outside of the Americas. Each is running a stripped-down version of our infrastructure, including:</p>

<ul>
<li>a frontend web server (nginx)</li>
<li>two instsances of our node.js API server</li>
<li>a partial database slave (for validating access tokens)</li>
<li>our offline loading process (soon to be open-sourced!), for doing async writes to the active master database.</li>
</ul>


<p>Switching DNS to Dyn requires changing the nameservers, which can take &#8220;up to 48 hours&#8221;. At the start of this story, it&#8217;s been about 36 hours. To play it safe, after testing out Dyn on a separate domain, we configured it to have the same settings as we had before &#8211; lb3 and lb4 are not in play yet.</p>

<h2>Timeline</h2>

<p>Now the (abbreviated) timeline. All times are PST.</p>

<div style="padding-left:2em;">
<p>9:30pm: Cory got an alert from Pingdom that our website (rollbar.com) was down. He tried visiting it but it wouldn&#8217;t load (just hung). Remembering the pending DNS change, he immediately checked DNS propagation and saw that rollbar.com was pointing at the wrong load balancer &#8211; lb1 (the API tier), not lb2.

<p>Cory and Sergei investigated. The A record for rollbar.com showed as correct in Dyn, but DNS was resolving incorrectly.

<p>9:47pm: Cory and Sergei looked at <a href="http://twitter.com/SoftlayerNotify" target="_blank">@SoftlayerNotify</a> and saw that there was an issue underway with one of the routers in the San Jose data center.

<p>9:49pm: Website accessible by its IP address.

<p>9:51pm: No longer accessible by IP.

<p>10:05pm: Twitter search for &#8220;softlayer outage&#8221; shows other people being affected.

<p>10:05pm: API tier (api.rollbar.com) appears to be working. Sergei verifies that it&#8217;s hitting lb3 (in Singapore).
</div>


<p>You might notice that we said before that lb3 wasn&#8217;t supposed to be in service yet. What appeared to have happened DNS had automatically failed over to lb3 (since lb1 was down because of the Softlayer outage). We had set something like this up before when testing out Dyn, but it wasn&#8217;t supposed to be active yet. Fortunately, lb3 was ready to go and handled all of our API load just fine.</p>

<div style="padding-left:2em;">
<p>10:22pm: Sergei tries fiddling with the Dyn configuration to see if anything helps.

<p>10:35pm: Sergei starts trying to get ahold Dyn

<p>10:58pm: Softlayer posts that &#8220;13 out of 14 rows of servers are online&#8221;. We must be in the 14th, because we&#8217;re still unreachable at this point. Brian tries hard-rebooting the &#8216;dev&#8217; server to see if it helps. It doesn&#8217;t.

<p>11:15pm: Sergei gets a call from Dyn, who tells him that the problem was a &#8220;stale Real-Time Traffic Manager configuration&#8221; and they&#8217;re looking into it.

<p>11:54pm: @SoftlayerNotify posts that &#8220;all servers are online however some intermittent problems remain&#8221;

<p>11:55pm: Sergei notices that the A record for rollbar.com in the Dyn interface appears to have been deleted, and he can&#8217;t add it back.

<p>12:00am: Brian sees that rollbar.com is working again. Cory notices that API calls are hitting lb2, causing them to hit the old, non-optimized API handling code on our web tier, overloading them and causing the website to hang. Frequent process restarts minimize the impact.

<p>12:19am: Sergei gets an email back from Dyn saying that they&#8217;re still looking into the problem.

<p>12:28am: Dyn calls to say they were able to fix everything. Sergei confirms. lb3 and lb4 are now fully utilized.

<p>12:42am: Brian tweets that all systems are stable.

<p>2:58am: Softlayer tweets that they&#8217;re about to run some code upgrades on the troubled router, which will cause some public network disruption.

<p>4:00am:- A customer reports connectivity issues to rollbar.com

<p>4:10am: Softlayer tweets that the troubled router is finally stable.
</div>


<h2>So what happened here?</h2>

<ol>
<li>Softlayer experienced a network outage, causing our servers in San Jose to be intermittently, then fully, unreachable</li>
<li>This triggered a DNS failover controlled by a stale Dyn configuration, which cascaded into a broken set of DNS records</li>
<li>After about 3 hours, our San Jose servers came back online, and about 30 minutes after that, the DNS issue was resolved.</li>
</ol>


<h2>What went right</h2>

<ul>
<li>We were notified of the problem by our backup monitoring service, Pingdom. (We&#8217;re using Nagios as our primary, but it runs inside of San Jose.)</li>
<li>Dyn&#8217;s DNS failover did work, even though wasn&#8217;t really supposed to be turned on. Our logs don&#8217;t show any large gaps in customer data being received.</li>
<li>A single machine (lb3) was able to handle all of our API traffic during the outage.</li>
<li>The API tier was able to handle a master-offline situation.</li>
<li>When San Jose came back online, data processing quickly caught up, notifications were sent, and the system was stable.</li>
<li>Our team came together, stayed mostly calm, and did everything we reasonably could to restore service as quickly as possible.</li>
</ul>


<p>As a bonus, our Singapore and Amsterdam servers are <a href="http://www.whatsmydns.net/#A/api.rollbar.com">now in service</a>.</p>

<h2>What went wrong</h2>

<ul>
<li>Parts of our service were unusable for a long period of time

<ul>
<li>Notifications for new errors, etc. weren&#8217;t sent</li>
<li>The web app didn&#8217;t load, and there was no maintenance page.</li>
<li><a href="http://status.rollbar.com">status.rollbar.com</a> didn&#8217;t show useful information</li>
</ul>
</li>
<li>Even though the Softlayer private network was at least partially accessible, we couldn&#8217;t access it because we only had one way in (&#8216;dev&#8217;, in San Jose).</li>
<li>The web tier got crushed trying to handle the API load with its old code.</li>
</ul>


<h2>Action items</h2>

<p>In the short term (most of this will get done today):</p>

<div style="padding-left:2em;">
<p><i>1b.</i> Set up a web server in a separate datacenter to serve a maintenance page.

<p><i>1c.</i> Add meta-level checks to status.rollbar.com. It currently gets data pushed from Nagios, but this isn&#8217;t helpful when San Jose is entirely unreachable.

<p><i>2.</i> Add another &#8216;dev&#8217;-like machine that we can use to administer servers, deploy code, etc. if San Jose is unreachable

<p><i>3.</i> Remove that old code, and make it an error if any API traffic hits the web tier.
</div>


<p>And longer term:</p>

<div style="padding-left:2em;">
<p><i>1a.</i> Add a host master standby in another datacenter for fast failover. If an episode like last night&#8217;s happens again, this will let us get notifications back online in a few minutes instead of a few hours.

<p><i>1b.</i> Set up a read-only web tier in another datacenter
</div>


<h2>Conclusion</h2>

<p>We hope this was, if nothing else, an interesting look into our infrastructure, and to the journey of building a highly-available we service.</p>

<p>If you have any questions about the outage or otherwise, let us know in the comments or email us at support@rollbar.com</p>
</div>
  
  


    </article>
    <hr>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <ul class="well nav nav-list" id="recent_posts">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/blog/post/2013/08/02/javascript-and-source-maps-in-a-django-app/">JavaScript and Source Maps in a Django App</a>
      </li>
    
      <li class="post">
        <a href="/blog/post/2013/07/25/debug-production-errors-in-minified-javascript-with-source-maps-and-rollbar/">Debug Production Errors in Minified JS with Source Maps and Rollbar</a>
      </li>
    
      <li class="post">
        <a href="/blog/post/2013/07/12/Async-nodejs-API-server-testing/">Async node.js API server testing</a>
      </li>
    
      <li class="post">
        <a href="/blog/post/2013/05/29/may-release-roundup/">May Release Roundup</a>
      </li>
    
      <li class="post">
        <a href="/blog/post/2013/05/06/rules-engine-for-notifications-campfire-hipchat-jira-trello/">Rules Engine for Notifications, Plus Integrations with Campfire, Hipchat, JIRA, and Trello</a>
      </li>
    
    <li class="divider"></li>
    <li><a href="/blog/blog/archives">Blog Archives</a></li>
  </ul>
</section>
<section>
  <div class="well">
    <!-- Begin MailChimp Signup Form -->
    <style type="text/css">
        /* MailChimp Form Embed Code - Slim - 08/17/2011 */
        #mc_embed_signup form {display:block; position:relative; text-align:left; padding:10px 0 10px 3%}
        #mc_embed_signup h2 {font-weight:bold; padding:0; margin:15px 0; font-size:1.4em;}
        #mc_embed_signup input {border:1px solid #999; -webkit-appearance:none;}
        #mc_embed_signup input[type=checkbox]{-webkit-appearance:checkbox;}
        #mc_embed_signup input[type=radio]{-webkit-appearance:radio;}
        #mc_embed_signup input:focus {border-color:#333;}
        #mc_embed_signup .button {clear:both; background-color: #aaa; border: 0 none; border-radius:4px; color: #FFFFFF; cursor: pointer; display: inline-block; font-size:15px; font-weight: bold; height: 32px; line-height: 32px; margin: 0 5px 10px 0; padding:0; text-align: center; text-decoration: none; vertical-align: top; white-space: nowrap; width: auto;}
        #mc_embed_signup .button:hover {background-color:#777;}
        #mc_embed_signup .small-meta {font-size: 11px;}
        #mc_embed_signup .nowrap {white-space:nowrap;}     
        #mc_embed_signup .clear {clear:none; display:inline;}

        #mc_embed_signup label {display:block; font-size:16px; padding-bottom:10px; font-weight:bold;}
        #mc_embed_signup input.email {display:block; padding:8px 0; margin:0 4% 10px 0; text-indent:5px; width:58%; min-width:130px;}
        #mc_embed_signup input.button {display:block; width:35%; margin:0 0 10px 0; min-width:90px;}

        #mc_embed_signup div#mce-responses {float:left; top:-1.4em; padding:0em .5em 0em .5em; overflow:hidden; width:90%;margin: 0 5%; clear: both;}
        #mc_embed_signup div.response {margin:1em 0; padding:1em .5em .5em 0; font-weight:bold; float:left; top:-1.5em; z-index:1; width:80%;}
        #mc_embed_signup #mce-error-response {display:none;}
        #mc_embed_signup #mce-success-response {color:#529214; display:none;}
        #mc_embed_signup label.error {display:block; float:none; width:auto; margin-left:1.05em; text-align:left; padding:.5em 0;}
        #mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
        #mc_embed_signup form { padding-left: 0; }
        /* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
           We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. */
    </style>
    <div id="mc_embed_signup">
    <form action="http://rollbar.us7.list-manage.com/subscribe/post?u=7b6a5da2c826ee17fc52ae99e&amp;id=189708f83b" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
        <label for="mce-EMAIL">Subscribe to Updates</label>
        <p>Get new posts in your inbox:</p>
        <input style="width:100%;" type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
        <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </form>
    </div>

    <!--End mc_embed_signup-->
  </div>
</section>

  
</aside>

      </div>
    </div>
    
    <footer class="row-fluid">
      <div class="container">
        <div class="row-fluid footer-content">
          <div class="left-col pull-left"><a class="logo-footer" href="/"></a></div>
            <div class="right-col pull-left">
              <div class="item pull-left">
              <strong>Rollbar</strong>
              <ul>
                <li><a href="/home/">Home</a></li>
                <li><a href="/about">About us</a></li>
                <li><a href="/pricing">Pricing</a></li>
                <li><a href="mailto:jobs@rollbar.com?Subject=I+am+awesome,+hire+me!">Jobs</a></li>
                <li><a href="/blog/">Blog</a></li>
              </ul>
            </div>
            <div class="item pull-left">
              <strong>Features</strong>
              <ul>
                <li><a href="/features/multiplatform/">Monitor errors</a></li>
                <li><a href="/features/alerts/">Real-time Alerts</a></li>
                <li><a href="/features/dashboard/">Dashboard</a></li>
                <li><a href="/features/deploys/">Track Deploys</a></li>
                <li><a href="/features/people/">Person Tracking</a></li>
                <li><a href="/features/hosts/">Host Tracking</a></li>
                <li><a href="/features/bugtrackers/">Bug Tracker Integration</a></li>
                <li><a href="/features/github/">Github Integration</a></li>
                <li><a href="/features/">Other Features</a></li>
              </ul>
            </div>
            <div class="item pull-left">
              <strong>Resources</strong>
              <ul>
                <li><a href="/blog/">Blog</a></li>
                <li><a href="/docs/">Docs</a></li>
                <li><a href="/changelog">Change Log</a></li>
              </ul>
            </div>
            <div class="item pull-left">
              <strong>Support</strong>
              <ul>
                <li><a href="/docs/">Help Center</a></li>
                <li><a href="/tos">Terms of Service</a></li>
                <li><a href="/privacy">Privacy Policy</a></li>
                <li><a href="/contact">Contact Us</a></li>
              </ul>
              
              <div class="social">
                <strong>Share via</strong>
                <ul>
                  <li class="twitter"><a href="https://twitter.com/share?url=http://rollbar.com/"></a></li>
                  <li class="facebook"><a href="https://www.facebook.com/dialog/feed?app_id=516762375041550&link=http%3A%2F%2Frollbar.com%2F&picture=http%3A%2F%2Frollbar.com%2Fstatic%2Fimg2%2Flogo.png&name=Rollbar&caption=Monitor and analyze your application's errors and deploys in real-time.&redirect_uri=http%3A%2F%2Frollbar.com%2F" target="_blank"></a></li>
                  <li class="email last"><a href="mailto:?Subject=Rollbar" target="_blank"></a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="row-fluid footer-content-bottom">
          <p>&copy; 2013 Rollbar, Inc.</p>
        </div>
      </div>
    </footer>
    
    

<script type="text/javascript">
      var disqus_shortname = 'rollbar';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
